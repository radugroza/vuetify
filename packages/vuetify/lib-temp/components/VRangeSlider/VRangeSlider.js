// Styles
import './VRangeSlider.sass';
// Components
import VSlider from '../VSlider';
// Helpers
import { createRange, deepEqual, } from '../../util/helpers';
/* @vue/component */
export default VSlider.extend({
    name: 'v-range-slider',
    props: {
        value: {
            type: Array,
            default: () => ([0, 0]),
        },
    },
    data() {
        return {
            activeThumb: null,
            lazyValue: this.value,
        };
    },
    computed: {
        classes() {
            return {
                ...VSlider.options.computed.classes.call(this),
                'v-input--range-slider': true,
            };
        },
        internalValue: {
            get() {
                return this.lazyValue;
            },
            set(val) {
                // Round value to ensure the
                // entire slider range can
                // be selected with step
                let value = val.map((v = 0) => this.roundValue(Math.min(Math.max(v, this.minValue), this.maxValue)));
                // Switch values if range and wrong order
                if (value[0] > value[1] || value[1] < value[0]) {
                    if (this.activeThumb !== null) {
                        const toFocus = this.activeThumb === 1 ? 0 : 1;
                        const el = this.$refs[`thumb_${toFocus}`];
                        el.focus();
                    }
                    value = [value[1], value[0]];
                }
                this.lazyValue = value;
                if (!deepEqual(value, this.value))
                    this.$emit('input', value);
                this.validate();
            },
        },
        inputWidth() {
            return this.internalValue.map((v) => (this.roundValue(v) - this.minValue) / (this.maxValue - this.minValue) * 100);
        },
    },
    methods: {
        getTrackStyle(startLength, endLength, startPadding = 0, endPadding = 0) {
            const startDir = this.vertical ? this.$vuetify.rtl ? 'top' : 'bottom' : this.$vuetify.rtl ? 'right' : 'left';
            const endDir = this.vertical ? 'height' : 'width';
            const start = `calc(${startLength}% + ${startPadding}px)`;
            const end = `calc(${endLength}% + ${endPadding}px)`;
            return {
                transition: this.trackTransition,
                [startDir]: start,
                [endDir]: end,
            };
        },
        getIndexOfClosestValue(arr, v) {
            if (Math.abs(arr[0] - v) < Math.abs(arr[1] - v))
                return 0;
            else
                return 1;
        },
        genInput() {
            return createRange(2).map(i => {
                const input = VSlider.options.methods.genInput.call(this);
                input.data = input.data || {};
                input.data.attrs = input.data.attrs || {};
                input.data.attrs.value = this.internalValue[i];
                input.data.attrs.id = `input-${i ? 'max' : 'min'}-${this._uid}`;
                return input;
            });
        },
        genTrackContainer() {
            const children = [];
            const padding = this.isDisabled ? 10 : 0;
            const sections = [
                {
                    class: 'v-slider__track-background',
                    color: this.computedTrackColor,
                    styles: [0, this.inputWidth[0], 0, -padding],
                },
                {
                    class: this.isDisabled ? 'v-slider__track-background' : 'v-slider__track-fill',
                    color: this.isDisabled ? this.computedTrackColor : this.computedColor,
                    styles: [this.inputWidth[0], Math.abs(this.inputWidth[1] - this.inputWidth[0]), padding, padding * -2],
                },
                {
                    class: 'v-slider__track-background',
                    color: this.computedTrackColor,
                    styles: [this.inputWidth[1], Math.abs(100 - this.inputWidth[1]), padding, -padding],
                },
            ];
            if (this.$vuetify.rtl)
                sections.reverse();
            children.push(...sections.map(section => this.$createElement('div', this.setBackgroundColor(section.color, {
                staticClass: section.class,
                style: this.getTrackStyle(...section.styles),
            }))));
            return this.$createElement('div', {
                staticClass: 'v-slider__track-container',
                ref: 'track',
            }, children);
        },
        genChildren() {
            return [
                this.genInput(),
                this.genTrackContainer(),
                this.genSteps(),
                createRange(2).map(index => {
                    const value = this.internalValue[index];
                    const onDrag = (e) => {
                        this.isActive = true;
                        this.activeThumb = index;
                        this.onThumbMouseDown(e);
                    };
                    const onFocus = (e) => {
                        this.isFocused = true;
                        this.activeThumb = index;
                        this.$emit('focus', e);
                    };
                    const onBlur = (e) => {
                        this.isFocused = false;
                        this.activeThumb = null;
                        this.$emit('blur', e);
                    };
                    const valueWidth = this.inputWidth[index];
                    const isActive = this.isActive && this.activeThumb === index;
                    const isFocused = this.isFocused && this.activeThumb === index;
                    return this.genThumbContainer(value, valueWidth, isActive, isFocused, onDrag, onFocus, onBlur, `thumb_${index}`);
                }),
            ];
        },
        onSliderClick(e) {
            if (!this.isActive) {
                if (this.noClick) {
                    this.noClick = false;
                    return;
                }
                const { value, isInsideTrack } = this.parseMouseMove(e);
                if (isInsideTrack) {
                    this.activeThumb = this.getIndexOfClosestValue(this.internalValue, value);
                    const refName = `thumb_${this.activeThumb}`;
                    const thumbRef = this.$refs[refName];
                    thumbRef.focus();
                }
                this.setInternalValue(value);
                this.$emit('change', this.internalValue);
            }
        },
        onMouseMove(e) {
            const { value, isInsideTrack } = this.parseMouseMove(e);
            if (isInsideTrack && this.activeThumb === null) {
                this.activeThumb = this.getIndexOfClosestValue(this.internalValue, value);
            }
            this.setInternalValue(value);
        },
        onKeyDown(e) {
            if (this.activeThumb === null)
                return;
            const value = this.parseKeyDown(e, this.internalValue[this.activeThumb]);
            if (value == null)
                return;
            this.setInternalValue(value);
            this.$emit('change', this.internalValue);
        },
        setInternalValue(value) {
            this.internalValue = this.internalValue.map((v, i) => {
                if (i === this.activeThumb)
                    return value;
                else
                    return Number(v);
            });
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJhbmdlU2xpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVlJhbmdlU2xpZGVyL1ZSYW5nZVNsaWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyxxQkFBcUIsQ0FBQTtBQUU1QixhQUFhO0FBQ2IsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFBO0FBRWhDLFVBQVU7QUFDVixPQUFPLEVBQ0wsV0FBVyxFQUNYLFNBQVMsR0FDVixNQUFNLG9CQUFvQixDQUFBO0FBSzNCLG9CQUFvQjtBQUNwQixlQUFlLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDNUIsSUFBSSxFQUFFLGdCQUFnQjtJQUV0QixLQUFLLEVBQUU7UUFDTCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsS0FBSztZQUNYLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ3NCO0tBQ2hEO0lBRUQsSUFBSTtRQUNGLE9BQU87WUFDTCxXQUFXLEVBQUUsSUFBcUI7WUFDbEMsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLO1NBQ3RCLENBQUE7SUFDSCxDQUFDO0lBRUQsUUFBUSxFQUFFO1FBQ1IsT0FBTztZQUNMLE9BQU87Z0JBQ0wsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDOUMsdUJBQXVCLEVBQUUsSUFBSTthQUM5QixDQUFBO1FBQ0gsQ0FBQztRQUNELGFBQWEsRUFBRTtZQUNiLEdBQUc7Z0JBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFBO1lBQ3ZCLENBQUM7WUFDRCxHQUFHLENBQUUsR0FBYTtnQkFDaEIsNEJBQTRCO2dCQUM1QiwwQkFBMEI7Z0JBQzFCLHdCQUF3QjtnQkFDeEIsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMs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QUNKLENBQUM7S0FDRjtDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFN0eWxlc1xuaW1wb3J0ICcuL1ZSYW5nZVNsaWRlci5zYXNzJ1xuXG4vLyBDb21wb25lbnRzXG5pbXBvcnQgVlNsaWRlciBmcm9tICcuLi9WU2xpZGVyJ1xuXG4vLyBIZWxwZXJzXG5pbXBvcnQge1xuICBjcmVhdGVSYW5nZSxcbiAgZGVlcEVxdWFsLFxufSBmcm9tICcuLi8uLi91dGlsL2hlbHBlcnMnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBQcm9wVmFsaWRhdG9yIH0gZnJvbSAndnVlL3R5cGVzL29wdGlvbnMnXG5cbi8qIEB2dWUvY29tcG9uZW50ICovXG5leHBvcnQgZGVmYXVsdCBWU2xpZGVyLmV4dGVuZCh7XG4gIG5hbWU6ICd2LXJhbmdlLXNsaWRlcicsXG5cbiAgcHJvcHM6IHtcbiAgICB2YWx1ZToge1xuICAgICAgdHlwZTogQXJyYXksXG4gICAgICBkZWZhdWx0OiAoKSA9PiAoWzAsIDBdKSxcbiAgICB9IGFzIHVua25vd24gYXMgUHJvcFZhbGlkYXRvcjxbbnVtYmVyLCBudW1iZXJdPixcbiAgfSxcblxuICBkYXRhICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgYWN0aXZlVGh1bWI6IG51bGwgYXMgbnVsbCB8IG51bWJlcixcbiAgICAgIGxhenlWYWx1ZTogdGhpcy52YWx1ZSxcbiAgICB9XG4gIH0sXG5cbiAgY29tcHV0ZWQ6IHtcbiAgICBjbGFzc2VzICgpOiBvYmplY3Qge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uVlNsaWRlci5vcHRpb25zLmNvbXB1dGVkLmNsYXNzZXMuY2FsbCh0aGlzKSxcbiAgICAgICAgJ3YtaW5wdXQtLXJhbmdlLXNsaWRlcic6IHRydWUsXG4gICAgICB9XG4gICAgfSxcbiAgICBpbnRlcm5hbFZhbHVlOiB7XG4gICAgICBnZXQgKCk6IG51bWJlcltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGF6eVZhbHVlXG4gICAgICB9LFxuICAgICAgc2V0ICh2YWw6IG51bWJlcltdKSB7XG4gICAgICAgIC8vIFJvdW5kIHZhbHVlIHRvIGVuc3VyZSB0aGVcbiAgICAgICAgLy8gZW50aXJlIHNsaWRlciByYW5nZSBjYW5cbiAgICAgICAgLy8gYmUgc2VsZWN0ZWQgd2l0aCBzdGVwXG4gICAgICAgIGxldCB2YWx1ZSA9IHZhbC5tYXAoKHYgPSAwKSA9PiB0aGlzLnJvdW5kVmFsdWUoTWF0aC5taW4oTWF0aC5tYXgodiwgdGhpcy5taW5WYWx1ZSksIHRoaXMubWF4VmFsdWUpKSlcblxuICAgICAgICAvLyBTd2l0Y2ggdmFsdWVzIGlmIHJhbmdlIGFuZCB3cm9uZyBvcmRlclxuICAgICAgICBpZiAodmFsdWVbMF0gPiB2YWx1ZVsxXSB8fCB2YWx1ZVsxXSA8IHZhbHVlWzBdKSB7XG4gICAgICAgICAgaWYgKHRoaXMuYWN0aXZlVGh1bWIgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHRvRm9jdXMgPSB0aGlzLmFjdGl2ZVRodW1iID09PSAxID8gMCA6IDFcbiAgICAgICAgICAgIGNvbnN0IGVsID0gdGhpcy4kcmVmc1tgdGh1bWJfJHt0b0ZvY3VzfWBdIGFzIEhUTUxFbGVtZW50XG4gICAgICAgICAgICBlbC5mb2N1cygpXG4gICAgICAgICAgfVxuICAgICAgICAgIHZhbHVlID0gW3ZhbHVlWzFdLCB2YWx1ZVswXV1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGF6eVZhbHVlID0gdmFsdWVcbiAgICAgICAgaWYgKCFkZWVwRXF1YWwodmFsdWUsIHRoaXMudmFsdWUpKSB0aGlzLiRlbWl0KCdpbnB1dCcsIHZhbHVlKVxuXG4gICAgICAgIHRoaXMudmFsaWRhdGUoKVxuICAgICAgfSxcbiAgICB9LFxuICAgIGlucHV0V2lkdGggKCk6IG51bWJlcltdIHtcbiAgICAgIHJldHVybiB0aGlzLmludGVybmFsVmFsdWUubWFwKCh2OiBudW1iZXIpID0+IChcbiAgICAgICAgdGhpcy5yb3VuZFZhbHVlKHYpIC0gdGhpcy5taW5WYWx1ZSkgLyAodGhpcy5tYXhWYWx1ZSAtIHRoaXMubWluVmFsdWUpICogMTAwXG4gICAgICApXG4gICAgfSxcbiAgfSxcblxuICBtZXRob2RzOiB7XG4gICAgZ2V0VHJhY2tTdHlsZSAoc3RhcnRMZW5ndGg6IG51bWJlciwgZW5kTGVuZ3RoOiBudW1iZXIsIHN0YXJ0UGFkZGluZyA9IDAsIGVuZFBhZGRpbmcgPSAwKSB7XG4gICAgICBjb25zdCBzdGFydERpciA9IHRoaXMudmVydGljYWwgPyB0aGlzLiR2dWV0aWZ5LnJ0bCA/ICd0b3AnIDogJ2JvdHRvbScgOiB0aGlzLiR2dWV0aWZ5LnJ0bCA/ICdyaWdodCcgOiAnbGVmdCdcbiAgICAgIGNvbnN0IGVuZERpciA9IHRoaXMudmVydGljYWwgPyAnaGVpZ2h0JyA6ICd3aWR0aCdcblxuICAgICAgY29uc3Qgc3RhcnQgPSBgY2FsYygke3N0YXJ0TGVuZ3RofSUgKyAke3N0YXJ0UGFkZGluZ31weClgXG4gICAgICBjb25zdCBlbmQgPSBgY2FsYygke2VuZExlbmd0aH0lICsgJHtlbmRQYWRkaW5nfXB4KWBcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdHJhbnNpdGlvbjogdGhpcy50cmFja1RyYW5zaXRpb24sXG4gICAgICAgIFtzdGFydERpcl06IHN0YXJ0LFxuICAgICAgICBbZW5kRGlyXTogZW5kLFxuICAgICAgfVxuICAgIH0sXG4gICAgZ2V0SW5kZXhPZkNsb3Nlc3RWYWx1ZSAoYXJyOiBudW1iZXJbXSwgdjogbnVtYmVyKSB7XG4gICAgICBpZiAoTWF0aC5hYnMoYXJyWzBdIC0gdikgPCBNYXRoLmFicyhhcnJbMV0gLSB2KSkgcmV0dXJuIDBcbiAgICAgIGVsc2UgcmV0dXJuIDFcbiAgICB9LFxuICAgIGdlbklucHV0ICgpIHtcbiAgICAgIHJldHVybiBjcmVhdGVSYW5nZSgyKS5tYXAoaSA9PiB7XG4gICAgICAgIGNvbnN0IGlucHV0ID0gVlNsaWRlci5vcHRpb25zLm1ldGhvZHMuZ2VuSW5wdXQuY2FsbCh0aGlzKVxuXG4gICAgICAgIGlucHV0LmRhdGEgPSBpbnB1dC5kYXRhIHx8IHt9XG4gICAgICAgIGlucHV0LmRhdGEuYXR0cnMgPSBpbnB1dC5kYXRhLmF0dHJzIHx8IHt9XG4gICAgICAgIGlucHV0LmRhdGEuYXR0cnMudmFsdWUgPSB0aGlzLmludGVybmFsVmFsdWVbaV1cbiAgICAgICAgaW5wdXQuZGF0YS5hdHRycy5pZCA9IGBpbnB1dC0ke2kgPyAnbWF4JyA6ICdtaW4nfS0ke3RoaXMuX3VpZH1gXG5cbiAgICAgICAgcmV0dXJuIGlucHV0XG4gICAgICB9KVxuICAgIH0sXG4gICAgZ2VuVHJhY2tDb250YWluZXIgKCkge1xuICAgICAgY29uc3QgY2hpbGRyZW4gPSBbXVxuXG4gICAgICBjb25zdCBwYWRkaW5nID0gdGhpcy5pc0Rpc2FibGVkID8gMTAgOiAwXG4gICAgICBjb25zdCBzZWN0aW9uczogeyBjbGFzczogc3RyaW5nLCBjb2xvcjogc3RyaW5nIHwgdW5kZWZpbmVkLCBzdHlsZXM6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdIH1bXSA9IFtcbiAgICAgICAge1xuICAgICAgICAgIGNsYXNzOiAndi1zbGlkZXJfX3RyYWNrLWJhY2tncm91bmQnLFxuICAgICAgICAgIGNvbG9yOiB0aGlzLmNvbXB1dGVkVHJhY2tDb2xvcixcbiAgICAgICAgICBzdHlsZXM6IFswLCB0aGlzLmlucHV0V2lkdGhbMF0sIDAsIC1wYWRkaW5nXSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGNsYXNzOiB0aGlzLmlzRGlzYWJsZWQgPyAndi1zbGlkZXJfX3RyYWNrLWJhY2tncm91bmQnIDogJ3Ytc2xpZGVyX190cmFjay1maWxsJyxcbiAgICAgICAgICBjb2xvcjogdGhpcy5pc0Rpc2FibGVkID8gdGhpcy5jb21wdXRlZFRyYWNrQ29sb3IgOiB0aGlzLmNvbXB1dGVkQ29sb3IsXG4gICAgICAgICAgc3R5bGVzOiBbdGhpcy5pbnB1dFdpZHRoWzBdLCBNYXRoLmFicyh0aGlzLmlucHV0V2lkdGhbMV0gLSB0aGlzLmlucHV0V2lkdGhbMF0pLCBwYWRkaW5nLCBwYWRkaW5nICogLTJdLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgY2xhc3M6ICd2LXNsaWRlcl9fdHJhY2stYmFja2dyb3VuZCcsXG4gICAgICAgICAgY29sb3I6IHRoaXMuY29tcHV0ZWRUcmFja0NvbG9yLFxuICAgICAgICAgIHN0eWxlczogW3RoaXMuaW5wdXRXaWR0aFsxXSwgTWF0aC5hYnMoMTAwIC0gdGhpcy5pbnB1dFdpZHRoWzFdKSwgcGFkZGluZywgLXBhZGRpbmddLFxuICAgICAgICB9LFxuICAgICAgXVxuXG4gICAgICBpZiAodGhpcy4kdnVldGlmeS5ydGwpIHNlY3Rpb25zLnJldmVyc2UoKVxuXG4gICAgICBjaGlsZHJlbi5wdXNoKC4uLnNlY3Rpb25zLm1hcChzZWN0aW9uID0+IHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHRoaXMuc2V0QmFja2dyb3VuZENvbG9yKHNlY3Rpb24uY29sb3IsIHtcbiAgICAgICAgc3RhdGljQ2xhc3M6IHNlY3Rpb24uY2xhc3MsXG4gICAgICAgIHN0eWxlOiB0aGlzLmdldFRyYWNrU3R5bGUoLi4uc2VjdGlvbi5zdHlsZXMpLFxuICAgICAgfSkpKSlcblxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LXNsaWRlcl9fdHJhY2stY29udGFpbmVyJyxcbiAgICAgICAgcmVmOiAndHJhY2snLFxuICAgICAgfSwgY2hpbGRyZW4pXG4gICAgfSxcbiAgICBnZW5DaGlsZHJlbiAoKSB7XG4gICAgICByZXR1cm4gW1xuICAgICAgICB0aGlzLmdlbklucHV0KCksXG4gICAgICAgIHRoaXMuZ2VuVHJhY2tDb250YWluZXIoKSxcbiAgICAgICAgdGhpcy5nZW5TdGVwcygpLFxuICAgICAgICBjcmVhdGVSYW5nZSgyKS5tYXAoaW5kZXggPT4ge1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5pbnRlcm5hbFZhbHVlW2luZGV4XVxuICAgICAgICAgIGNvbnN0IG9uRHJhZyA9IChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZVxuICAgICAgICAgICAgdGhpcy5hY3RpdmVUaHVtYiA9IGluZGV4XG4gICAgICAgICAgICB0aGlzLm9uVGh1bWJNb3VzZURvd24oZSlcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgb25Gb2N1cyA9IChlOiBFdmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pc0ZvY3VzZWQgPSB0cnVlXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZVRodW1iID0gaW5kZXhcblxuICAgICAgICAgICAgdGhpcy4kZW1pdCgnZm9jdXMnLCBlKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IG9uQmx1ciA9IChlOiBFdmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pc0ZvY3VzZWQgPSBmYWxzZVxuICAgICAgICAgICAgdGhpcy5hY3RpdmVUaHVtYiA9IG51bGxcblxuICAgICAgICAgICAgdGhpcy4kZW1pdCgnYmx1cicsIGUpXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgdmFsdWVXaWR0aCA9IHRoaXMuaW5wdXRXaWR0aFtpbmRleF1cbiAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IHRoaXMuaXNBY3RpdmUgJiYgdGhpcy5hY3RpdmVUaHVtYiA9PT0gaW5kZXhcbiAgICAgICAgICBjb25zdCBpc0ZvY3VzZWQgPSB0aGlzLmlzRm9jdXNlZCAmJiB0aGlzLmFjdGl2ZVRodW1iID09PSBpbmRleFxuXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2VuVGh1bWJDb250YWluZXIodmFsdWUsIHZhbHVlV2lkdGgsIGlzQWN0aXZlLCBpc0ZvY3VzZWQsIG9uRHJhZywgb25Gb2N1cywgb25CbHVyLCBgdGh1bWJfJHtpbmRleH1gKVxuICAgICAgICB9KSxcbiAgICAgIF1cbiAgICB9LFxuICAgIG9uU2xpZGVyQ2xpY2sgKGU6IE1vdXNlRXZlbnQpIHtcbiAgICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgICBpZiAodGhpcy5ub0NsaWNrKSB7XG4gICAgICAgICAgdGhpcy5ub0NsaWNrID0gZmFsc2VcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIGlzSW5zaWRlVHJhY2sgfSA9IHRoaXMucGFyc2VNb3VzZU1vdmUoZSlcblxuICAgICAgICBpZiAoaXNJbnNpZGVUcmFjaykge1xuICAgICAgICAgIHRoaXMuYWN0aXZlVGh1bWIgPSB0aGlzLmdldEluZGV4T2ZDbG9zZXN0VmFsdWUodGhpcy5pbnRlcm5hbFZhbHVlLCB2YWx1ZSlcbiAgICAgICAgICBjb25zdCByZWZOYW1lID0gYHRodW1iXyR7dGhpcy5hY3RpdmVUaHVtYn1gXG4gICAgICAgICAgY29uc3QgdGh1bWJSZWYgPSB0aGlzLiRyZWZzW3JlZk5hbWVdIGFzIEhUTUxFbGVtZW50XG4gICAgICAgICAgdGh1bWJSZWYuZm9jdXMoKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRJbnRlcm5hbFZhbHVlKHZhbHVlKVxuXG4gICAgICAgIHRoaXMuJGVtaXQoJ2NoYW5nZScsIHRoaXMuaW50ZXJuYWxWYWx1ZSlcbiAgICAgIH1cbiAgICB9LFxuICAgIG9uTW91c2VNb3ZlIChlOiBNb3VzZUV2ZW50KSB7XG4gICAgICBjb25zdCB7IHZhbHVlLCBpc0luc2lkZVRyYWNrIH0gPSB0aGlzLnBhcnNlTW91c2VNb3ZlKGUpXG5cbiAgICAgIGlmIChpc0luc2lkZVRyYWNrICYmIHRoaXMuYWN0aXZlVGh1bWIgPT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5hY3RpdmVUaHVtYiA9IHRoaXMuZ2V0SW5kZXhPZkNsb3Nlc3RWYWx1ZSh0aGlzLmludGVybmFsVmFsdWUsIHZhbHVlKVxuICAgICAgfVxuXG4gICAgICB0aGlzLnNldEludGVybmFsVmFsdWUodmFsdWUpXG4gICAgfSxcbiAgICBvbktleURvd24gKGU6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgIGlmICh0aGlzLmFjdGl2ZVRodW1iID09PSBudWxsKSByZXR1cm5cblxuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnBhcnNlS2V5RG93bihlLCB0aGlzLmludGVybmFsVmFsdWVbdGhpcy5hY3RpdmVUaHVtYl0pXG5cbiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm5cblxuICAgICAgdGhpcy5zZXRJbnRlcm5hbFZhbHVlKHZhbHVlKVxuICAgICAgdGhpcy4kZW1pdCgnY2hhbmdlJywgdGhpcy5pbnRlcm5hbFZhbHVlKVxuICAgIH0sXG4gICAgc2V0SW50ZXJuYWxWYWx1ZSAodmFsdWU6IG51bWJlcikge1xuICAgICAgdGhpcy5pbnRlcm5hbFZhbHVlID0gdGhpcy5pbnRlcm5hbFZhbHVlLm1hcCgodjogbnVtYmVyLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgaWYgKGkgPT09IHRoaXMuYWN0aXZlVGh1bWIpIHJldHVybiB2YWx1ZVxuICAgICAgICBlbHNlIHJldHVybiBOdW1iZXIodilcbiAgICAgIH0pXG4gICAgfSxcbiAgfSxcbn0pXG4iXX0=