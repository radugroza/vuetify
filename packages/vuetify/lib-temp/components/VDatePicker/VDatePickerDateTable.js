// Mixins
import DatePickerTable from './mixins/date-picker-table';
// Utils
import { weekNumber } from '../../util/dateTimeUtils';
import { pad, createNativeLocaleFormatter, monthChange } from './util';
import { createRange } from '../../util/helpers';
import mixins from '../../util/mixins';
export default mixins(DatePickerTable
/* @vue/component */
).extend({
    name: 'v-date-picker-date-table',
    props: {
        firstDayOfWeek: {
            type: [String, Number],
            default: 0,
        },
        localeFirstDayOfYear: {
            type: [String, Number],
            default: 0,
        },
        showWeek: Boolean,
        weekdayFormat: Function,
    },
    computed: {
        formatter() {
            return this.format || createNativeLocaleFormatter(this.currentLocale, { day: 'numeric', timeZone: 'UTC' }, { start: 8, length: 2 });
        },
        weekdayFormatter() {
            return this.weekdayFormat || createNativeLocaleFormatter(this.currentLocale, { weekday: 'narrow', timeZone: 'UTC' });
        },
        weekDays() {
            const first = parseInt(this.firstDayOfWeek, 10);
            return this.weekdayFormatter
                ? createRange(7).map(i => this.weekdayFormatter(`2017-01-${first + i + 15}`)) // 2017-01-15 is Sunday
                : createRange(7).map(i => ['S', 'M', 'T', 'W', 'T', 'F', 'S'][(i + first) % 7]);
        },
    },
    methods: {
        calculateTableDate(delta) {
            return monthChange(this.tableDate, Math.sign(delta || 1));
        },
        genTHead() {
            const days = this.weekDays.map(day => this.$createElement('th', day));
            if (this.showWeek) {
                days.unshift(this.$createElement('th'));
            }
            return this.$createElement('thead', this.genTR(days));
        },
        // Returns number of the days from the firstDayOfWeek to the first day of the current month
        weekDaysBeforeFirstDayOfTheMonth() {
            const firstDayOfTheMonth = new Date(`${this.displayedYear}-${pad(this.displayedMonth + 1)}-01T00:00:00+00:00`);
            const weekDay = firstDayOfTheMonth.getUTCDay();
            return (weekDay - parseInt(this.firstDayOfWeek) + 7) % 7;
        },
        getWeekNumber(dayInMonth) {
            return weekNumber(this.displayedYear, this.displayedMonth, dayInMonth, parseInt(this.firstDayOfWeek), parseInt(this.localeFirstDayOfYear));
        },
        genWeekNumber(weekNumber) {
            return this.$createElement('td', [
                this.$createElement('small', {
                    staticClass: 'v-date-picker-table--date__week',
                }, String(weekNumber).padStart(2, '0')),
            ]);
        },
        genTBody() {
            const children = [];
            const daysInMonth = new Date(this.displayedYear, this.displayedMonth + 1, 0).getDate();
            let rows = [];
            let day = this.weekDaysBeforeFirstDayOfTheMonth();
            if (this.showWeek) {
                rows.push(this.genWeekNumber(this.getWeekNumber(1)));
            }
            while (day--)
                rows.push(this.$createElement('td'));
            for (day = 1; day <= daysInMonth; day++) {
                const date = `${this.displayedYear}-${pad(this.displayedMonth + 1)}-${pad(day)}`;
                rows.push(this.$createElement('td', [
                    this.genButton(date, true, 'date', this.formatter),
                ]));
                if (rows.length % (this.showWeek ? 8 : 7) === 0) {
                    children.push(this.genTR(rows));
                    rows = [];
                    if (this.showWeek && (day < daysInMonth)) {
                        rows.push(this.genWeekNumber(this.getWeekNumber(day + 7)));
                    }
                }
            }
            if (rows.length) {
                children.push(this.genTR(rows));
            }
            return this.$createElement('tbody', children);
        },
        genTR(children) {
            return [this.$createElement('tr', children)];
        },
    },
    render() {
        return this.genTable('v-date-picker-table v-date-picker-table--date', [
            this.genTHead(),
            this.genTBody(),
        ], this.calculateTableDate);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGVQaWNrZXJEYXRlVGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WRGF0ZVBpY2tlci9WRGF0ZVBpY2tlckRhdGVUYWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyxlQUFlLE1BQU0sNEJBQTRCLENBQUE7QUFFeEQsUUFBUTtBQUNSLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQTtBQUNyRCxPQUFPLEVBQUUsR0FBRyxFQUFFLDJCQUEyQixFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQTtBQUN0RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDaEQsT0FBTyxNQUFNLE1BQU0sbUJBQW1CLENBQUE7QUFNdEMsZUFBZSxNQUFNLENBQ25CLGVBQWU7QUFDakIsb0JBQW9CO0NBQ25CLENBQUMsTUFBTSxDQUFDO0lBQ1AsSUFBSSxFQUFFLDBCQUEwQjtJQUVoQyxLQUFLLEVBQUU7UUFDTCxjQUFjLEVBQUU7WUFDZCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxvQkFBb0IsRUFBRTtZQUNwQixJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxRQUFRLEVBQUUsT0FBTztRQUNqQixhQUFhLEVBQUUsUUFBcUQ7S0FDckU7SUFFRCxRQUFRLEVBQUU7UUFDUixTQUFTO1lBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxJQUFJLDJCQUEyQixDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUE7UUFD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QUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO29CQUMvQixJQUFJLEdBQUcsRUFBRSxDQUFBO29CQUNULElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLEdBQUcsR0FBRyxXQUFXLENBQUMsRUFBRTt3QkFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtxQkFDM0Q7aUJBQ0Y7YUFDRjtZQUVELElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDZixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTthQUNoQztZQUVELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFDL0MsQ0FBQztRQUNELEtBQUssQ0FBRSxRQUF1QjtZQUM1QixPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQTtRQUM5QyxDQUFDO0tBQ0Y7SUFFRCxNQUFNO1FBQ0osT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLCtDQUErQyxFQUFFO1lBQ3BFLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDZixJQUFJLENBQUMsUUFBUSxFQUFFO1NBQ2hCLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUE7SUFDN0IsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIE1peGluc1xuaW1wb3J0IERhdGVQaWNrZXJUYWJsZSBmcm9tICcuL21peGlucy9kYXRlLXBpY2tlci10YWJsZSdcblxuLy8gVXRpbHNcbmltcG9ydCB7IHdlZWtOdW1iZXIgfSBmcm9tICcuLi8uLi91dGlsL2RhdGVUaW1lVXRpbHMnXG5pbXBvcnQgeyBwYWQsIGNyZWF0ZU5hdGl2ZUxvY2FsZUZvcm1hdHRlciwgbW9udGhDaGFuZ2UgfSBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBjcmVhdGVSYW5nZSB9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycydcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vdXRpbC9taXhpbnMnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBWTm9kZSwgVk5vZGVDaGlsZHJlbiwgUHJvcFR5cGUgfSBmcm9tICd2dWUnXG5pbXBvcnQgeyBEYXRlUGlja2VyRm9ybWF0dGVyIH0gZnJvbSAndnVldGlmeS90eXBlcydcblxuZXhwb3J0IGRlZmF1bHQgbWl4aW5zKFxuICBEYXRlUGlja2VyVGFibGVcbi8qIEB2dWUvY29tcG9uZW50ICovXG4pLmV4dGVuZCh7XG4gIG5hbWU6ICd2LWRhdGUtcGlja2VyLWRhdGUtdGFibGUnLFxuXG4gIHByb3BzOiB7XG4gICAgZmlyc3REYXlPZldlZWs6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgbG9jYWxlRmlyc3REYXlPZlllYXI6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgc2hvd1dlZWs6IEJvb2xlYW4sXG4gICAgd2Vla2RheUZvcm1hdDogRnVuY3Rpb24gYXMgUHJvcFR5cGU8RGF0ZVBpY2tlckZvcm1hdHRlciB8IHVuZGVmaW5lZD4sXG4gIH0sXG5cbiAgY29tcHV0ZWQ6IHtcbiAgICBmb3JtYXR0ZXIgKCk6IERhdGVQaWNrZXJGb3JtYXR0ZXIge1xuICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0IHx8IGNyZWF0ZU5hdGl2ZUxvY2FsZUZvcm1hdHRlcih0aGlzLmN1cnJlbnRMb2NhbGUsIHsgZGF5OiAnbnVtZXJpYycsIHRpbWVab25lOiAnVVRDJyB9LCB7IHN0YXJ0OiA4LCBsZW5ndGg6IDIgfSlcbiAgICB9LFxuICAgIHdlZWtkYXlGb3JtYXR0ZXIgKCk6IERhdGVQaWNrZXJGb3JtYXR0ZXIgfCB1bmRlZmluZWQge1xuICAgICAgcmV0dXJuIHRoaXMud2Vla2RheUZvcm1hdCB8fCBjcmVhdGVOYXRpdmVMb2NhbGVGb3JtYXR0ZXIodGhpcy5jdXJyZW50TG9jYWxlLCB7IHdlZWtkYXk6ICduYXJyb3cnLCB0aW1lWm9uZTogJ1VUQycgfSlcbiAgICB9LFxuICAgIHdlZWtEYXlzICgpOiBzdHJpbmdbXSB7XG4gICAgICBjb25zdCBmaXJzdCA9IHBhcnNlSW50KHRoaXMuZmlyc3REYXlPZldlZWssIDEwKVxuXG4gICAgICByZXR1cm4gdGhpcy53ZWVrZGF5Rm9ybWF0dGVyXG4gICAgICAgID8gY3JlYXRlUmFuZ2UoNykubWFwKGkgPT4gdGhpcy53ZWVrZGF5Rm9ybWF0dGVyIShgMjAxNy0wMS0ke2ZpcnN0ICsgaSArIDE1fWApKSAvLyAyMDE3LTAxLTE1IGlzIFN1bmRheVxuICAgICAgICA6IGNyZWF0ZVJhbmdlKDcpLm1hcChpID0+IFsnUycsICdNJywgJ1QnLCAnVycsICdUJywgJ0YnLCAnUyddWyhpICsgZmlyc3QpICUgN10pXG4gICAgfSxcbiAgfSxcblxuICBtZXRob2RzOiB7XG4gICAgY2FsY3VsYXRlVGFibGVEYXRlIChkZWx0YTogbnVtYmVyKSB7XG4gICAgICByZXR1cm4gbW9udGhDaGFuZ2UodGhpcy50YWJsZURhdGUsIE1hdGguc2lnbihkZWx0YSB8fCAxKSlcbiAgICB9LFxuICAgIGdlblRIZWFkICgpIHtcbiAgICAgIGNvbnN0IGRheXMgPSB0aGlzLndlZWtEYXlzLm1hcChkYXkgPT4gdGhpcy4kY3JlYXRlRWxlbWVudCgndGgnLCBkYXkpKVxuICAgICAgaWYgKHRoaXMuc2hvd1dlZWspIHtcbiAgICAgICAgZGF5cy51bnNoaWZ0KHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RoJykpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCd0aGVhZCcsIHRoaXMuZ2VuVFIoZGF5cykpXG4gICAgfSxcbiAgICAvLyBSZXR1cm5zIG51bWJlciBvZiB0aGUgZGF5cyBmcm9tIHRoZSBmaXJzdERheU9mV2VlayB0byB0aGUgZmlyc3QgZGF5IG9mIHRoZSBjdXJyZW50IG1vbnRoXG4gICAgd2Vla0RheXNCZWZvcmVGaXJzdERheU9mVGhlTW9udGggKCkge1xuICAgICAgY29uc3QgZmlyc3REYXlPZlRoZU1vbnRoID0gbmV3IERhdGUoYCR7dGhpcy5kaXNwbGF5ZWRZZWFyfS0ke3BhZCh0aGlzLmRpc3BsYXllZE1vbnRoICsgMSl9LTAxVDAwOjAwOjAwKzAwOjAwYClcbiAgICAgIGNvbnN0IHdlZWtEYXkgPSBmaXJzdERheU9mVGhlTW9udGguZ2V0VVRDRGF5KClcblxuICAgICAgcmV0dXJuICh3ZWVrRGF5IC0gcGFyc2VJbnQodGhpcy5maXJzdERheU9mV2VlaykgKyA3KSAlIDdcbiAgICB9LFxuICAgIGdldFdlZWtOdW1iZXIgKGRheUluTW9udGg6IG51bWJlcikge1xuICAgICAgcmV0dXJuIHdlZWtOdW1iZXIoXG4gICAgICAgIHRoaXMuZGlzcGxheWVkWWVhcixcbiAgICAgICAgdGhpcy5kaXNwbGF5ZWRNb250aCxcbiAgICAgICAgZGF5SW5Nb250aCxcbiAgICAgICAgcGFyc2VJbnQodGhpcy5maXJzdERheU9mV2VlayksXG4gICAgICAgIHBhcnNlSW50KHRoaXMubG9jYWxlRmlyc3REYXlPZlllYXIpXG4gICAgICApXG4gICAgfSxcbiAgICBnZW5XZWVrTnVtYmVyICh3ZWVrTnVtYmVyOiBudW1iZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCd0ZCcsIFtcbiAgICAgICAgdGhpcy4kY3JlYXRlRWxlbWVudCgnc21hbGwnLCB7XG4gICAgICAgICAgc3RhdGljQ2xhc3M6ICd2LWRhdGUtcGlja2VyLXRhYmxlLS1kYXRlX193ZWVrJyxcbiAgICAgICAgfSwgU3RyaW5nKHdlZWtOdW1iZXIpLnBhZFN0YXJ0KDIsICcwJykpLFxuICAgICAgXSlcbiAgICB9LFxuICAgIGdlblRCb2R5ICgpIHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gW11cbiAgICAgIGNvbnN0IGRheXNJbk1vbnRoID0gbmV3IERhdGUodGhpcy5kaXNwbGF5ZWRZZWFyLCB0aGlzLmRpc3BsYXllZE1vbnRoICsgMSwgMCkuZ2V0RGF0ZSgpXG4gICAgICBsZXQgcm93cyA9IFtdXG4gICAgICBsZXQgZGF5ID0gdGhpcy53ZWVrRGF5c0JlZm9yZUZpcnN0RGF5T2ZUaGVNb250aCgpXG5cbiAgICAgIGlmICh0aGlzLnNob3dXZWVrKSB7XG4gICAgICAgIHJvd3MucHVzaCh0aGlzLmdlbldlZWtOdW1iZXIodGhpcy5nZXRXZWVrTnVtYmVyKDEpKSlcbiAgICAgIH1cblxuICAgICAgd2hpbGUgKGRheS0tKSByb3dzLnB1c2godGhpcy4kY3JlYXRlRWxlbWVudCgndGQnKSlcbiAgICAgIGZvciAoZGF5ID0gMTsgZGF5IDw9IGRheXNJbk1vbnRoOyBkYXkrKykge1xuICAgICAgICBjb25zdCBkYXRlID0gYCR7dGhpcy5kaXNwbGF5ZWRZZWFyfS0ke3BhZCh0aGlzLmRpc3BsYXllZE1vbnRoICsgMSl9LSR7cGFkKGRheSl9YFxuXG4gICAgICAgIHJvd3MucHVzaCh0aGlzLiRjcmVhdGVFbGVtZW50KCd0ZCcsIFtcbiAgICAgICAgICB0aGlzLmdlbkJ1dHRvbihkYXRlLCB0cnVlLCAnZGF0ZScsIHRoaXMuZm9ybWF0dGVyKSxcbiAgICAgICAgXSkpXG5cbiAgICAgICAgaWYgKHJvd3MubGVuZ3RoICUgKHRoaXMuc2hvd1dlZWsgPyA4IDogNykgPT09IDApIHtcbiAgICAgICAgICBjaGlsZHJlbi5wdXNoKHRoaXMuZ2VuVFIocm93cykpXG4gICAgICAgICAgcm93cyA9IFtdXG4gICAgICAgICAgaWYgKHRoaXMuc2hvd1dlZWsgJiYgKGRheSA8IGRheXNJbk1vbnRoKSkge1xuICAgICAgICAgICAgcm93cy5wdXNoKHRoaXMuZ2VuV2Vla051bWJlcih0aGlzLmdldFdlZWtOdW1iZXIoZGF5ICsgNykpKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAocm93cy5sZW5ndGgpIHtcbiAgICAgICAgY2hpbGRyZW4ucHVzaCh0aGlzLmdlblRSKHJvd3MpKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgndGJvZHknLCBjaGlsZHJlbilcbiAgICB9LFxuICAgIGdlblRSIChjaGlsZHJlbjogVk5vZGVDaGlsZHJlbikge1xuICAgICAgcmV0dXJuIFt0aGlzLiRjcmVhdGVFbGVtZW50KCd0cicsIGNoaWxkcmVuKV1cbiAgICB9LFxuICB9LFxuXG4gIHJlbmRlciAoKTogVk5vZGUge1xuICAgIHJldHVybiB0aGlzLmdlblRhYmxlKCd2LWRhdGUtcGlja2VyLXRhYmxlIHYtZGF0ZS1waWNrZXItdGFibGUtLWRhdGUnLCBbXG4gICAgICB0aGlzLmdlblRIZWFkKCksXG4gICAgICB0aGlzLmdlblRCb2R5KCksXG4gICAgXSwgdGhpcy5jYWxjdWxhdGVUYWJsZURhdGUpXG4gIH0sXG59KVxuIl19