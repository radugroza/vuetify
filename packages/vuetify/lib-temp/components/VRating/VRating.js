// Styles
import './VRating.sass';
// Components
import VIcon from '../VIcon';
// Mixins
import Colorable from '../../mixins/colorable';
import Delayable from '../../mixins/delayable';
import Sizeable from '../../mixins/sizeable';
import Rippleable from '../../mixins/rippleable';
import Themeable from '../../mixins/themeable';
// Utilities
import { createRange } from '../../util/helpers';
import mixins from '../../util/mixins';
/* @vue/component */
export default mixins(Colorable, Delayable, Rippleable, Sizeable, Themeable).extend({
    name: 'v-rating',
    props: {
        backgroundColor: {
            type: String,
            default: 'accent',
        },
        color: {
            type: String,
            default: 'primary',
        },
        clearable: Boolean,
        dense: Boolean,
        emptyIcon: {
            type: String,
            default: '$ratingEmpty',
        },
        fullIcon: {
            type: String,
            default: '$ratingFull',
        },
        halfIcon: {
            type: String,
            default: '$ratingHalf',
        },
        halfIncrements: Boolean,
        hover: Boolean,
        length: {
            type: [Number, String],
            default: 5,
        },
        readonly: Boolean,
        size: [Number, String],
        value: {
            type: Number,
            default: 0,
        },
    },
    data() {
        return {
            hoverIndex: -1,
            internalValue: this.value,
        };
    },
    computed: {
        directives() {
            if (this.readonly || !this.ripple)
                return [];
            return [{
                    name: 'ripple',
                    value: { circle: true },
                }];
        },
        iconProps() {
            const { dark, large, light, medium, small, size, xLarge, xSmall, } = this.$props;
            return {
                dark,
                large,
                light,
                medium,
                size,
                small,
                xLarge,
                xSmall,
            };
        },
        isHovering() {
            return this.hover && this.hoverIndex >= 0;
        },
    },
    watch: {
        internalValue(val) {
            val !== this.value && this.$emit('input', val);
        },
        value(val) {
            this.internalValue = val;
        },
    },
    methods: {
        createClickFn(i) {
            return (e) => {
                if (this.readonly)
                    return;
                const newValue = this.genHoverIndex(e, i);
                if (this.clearable && this.internalValue === newValue) {
                    this.internalValue = 0;
                }
                else {
                    this.internalValue = newValue;
                }
            };
        },
        createProps(i) {
            const props = {
                index: i,
                value: this.internalValue,
                click: this.createClickFn(i),
                isFilled: Math.floor(this.internalValue) > i,
                isHovered: Math.floor(this.hoverIndex) > i,
            };
            if (this.halfIncrements) {
                props.isHalfHovered = !props.isHovered && (this.hoverIndex - i) % 1 > 0;
                props.isHalfFilled = !props.isFilled && (this.internalValue - i) % 1 > 0;
            }
            return props;
        },
        genHoverIndex(e, i) {
            let isHalf = this.isHalfEvent(e);
            if (this.halfIncrements &&
                this.$vuetify.rtl) {
                isHalf = !isHalf;
            }
            return i + (isHalf ? 0.5 : 1);
        },
        getIconName(props) {
            const isFull = this.isHovering ? props.isHovered : props.isFilled;
            const isHalf = this.isHovering ? props.isHalfHovered : props.isHalfFilled;
            return isFull ? this.fullIcon : isHalf ? this.halfIcon : this.emptyIcon;
        },
        getColor(props) {
            if (this.isHovering) {
                if (props.isHovered || props.isHalfHovered)
                    return this.color;
            }
            else {
                if (props.isFilled || props.isHalfFilled)
                    return this.color;
            }
            return this.backgroundColor;
        },
        isHalfEvent(e) {
            if (this.halfIncrements) {
                const rect = e.target && e.target.getBoundingClientRect();
                if (rect && (e.pageX - rect.left) < rect.width / 2)
                    return true;
            }
            return false;
        },
        onMouseEnter(e, i) {
            this.runDelay('open', () => {
                this.hoverIndex = this.genHoverIndex(e, i);
            });
        },
        onMouseLeave() {
            this.runDelay('close', () => (this.hoverIndex = -1));
        },
        genItem(i) {
            const props = this.createProps(i);
            if (this.$scopedSlots.item)
                return this.$scopedSlots.item(props);
            const listeners = {
                click: props.click,
            };
            if (this.hover) {
                listeners.mouseenter = (e) => this.onMouseEnter(e, i);
                listeners.mouseleave = this.onMouseLeave;
                if (this.halfIncrements) {
                    listeners.mousemove = (e) => this.onMouseEnter(e, i);
                }
            }
            return this.$createElement(VIcon, this.setTextColor(this.getColor(props), {
                attrs: { tabindex: -1 },
                directives: this.directives,
                props: this.iconProps,
                on: listeners,
            }), [this.getIconName(props)]);
        },
    },
    render(h) {
        const children = createRange(Number(this.length)).map(i => this.genItem(i));
        return h('div', {
            staticClass: 'v-rating',
            class: {
                'v-rating--readonly': this.readonly,
                'v-rating--dense': this.dense,
            },
        }, children);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJhdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZSYXRpbmcvVlJhdGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyxnQkFBZ0IsQ0FBQTtBQUV2QixhQUFhO0FBQ2IsT0FBTyxLQUFLLE1BQU0sVUFBVSxDQUFBO0FBRTVCLFNBQVM7QUFDVCxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUM5QyxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUM5QyxPQUFPLFFBQVEsTUFBTSx1QkFBdUIsQ0FBQTtBQUM1QyxPQUFPLFVBQVUsTUFBTSx5QkFBeUIsQ0FBQTtBQUNoRCxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUU5QyxZQUFZO0FBQ1osT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQ2hELE9BQU8sTUFBTSxNQUFNLG1CQUFtQixDQUFBO0FBZXRDLG9CQUFvQjtBQUNwQixlQUFlLE1BQU0sQ0FDbkIsU0FBUyxFQUNULFNBQVMsRUFDVCxVQUFVLEVBQ1YsUUFBUSxFQUNSLFNBQVMsQ0FDVixDQUFDLE1BQU0sQ0FBQztJQUNQLElBQUksRUFBRSxVQUFVO0lBRWhCLEtBQUssRUFBRTtRQUNMLGVBQWUsRUFBRTtZQUNmLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLFFBQVE7U0FDbEI7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxTQUFTO1NBQ25CO1FBQ0QsU0FBUyxFQUFFLE9BQU87UUFDbEIsS0FBSyxFQUFFLE9BQU87UUFDZCxTQUFTLEVBQUU7WUFDVCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxjQUFjO1NBQ3hCO1FBQ0QsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsYUFBYTtTQUN2QjtRQUNELFFBQVEsRUFBRTtZ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LENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBRTNFLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRTtZQUNkLFdBQVcsRUFBRSxVQUFVO1lBQ3ZCLEtBQUssRUFBRTtnQkFDTCxvQkFBb0IsRUFBRSxJQUFJLENBQUMsUUFBUTtnQkFDbkMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLEtBQUs7YUFDOUI7U0FDRixFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ2QsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFN0eWxlc1xuaW1wb3J0ICcuL1ZSYXRpbmcuc2FzcydcblxuLy8gQ29tcG9uZW50c1xuaW1wb3J0IFZJY29uIGZyb20gJy4uL1ZJY29uJ1xuXG4vLyBNaXhpbnNcbmltcG9ydCBDb2xvcmFibGUgZnJvbSAnLi4vLi4vbWl4aW5zL2NvbG9yYWJsZSdcbmltcG9ydCBEZWxheWFibGUgZnJvbSAnLi4vLi4vbWl4aW5zL2RlbGF5YWJsZSdcbmltcG9ydCBTaXplYWJsZSBmcm9tICcuLi8uLi9taXhpbnMvc2l6ZWFibGUnXG5pbXBvcnQgUmlwcGxlYWJsZSBmcm9tICcuLi8uLi9taXhpbnMvcmlwcGxlYWJsZSdcbmltcG9ydCBUaGVtZWFibGUgZnJvbSAnLi4vLi4vbWl4aW5zL3RoZW1lYWJsZSdcblxuLy8gVXRpbGl0aWVzXG5pbXBvcnQgeyBjcmVhdGVSYW5nZSB9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycydcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vdXRpbC9taXhpbnMnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBWTm9kZSwgVk5vZGVEaXJlY3RpdmUsIFZOb2RlQ2hpbGRyZW4gfSBmcm9tICd2dWUnXG5cbnR5cGUgSXRlbVNsb3RQcm9wcyA9IHtcbiAgaW5kZXg6IG51bWJlclxuICB2YWx1ZTogbnVtYmVyXG4gIGlzRmlsbGVkOiBib29sZWFuXG4gIGlzSGFsZkZpbGxlZD86IGJvb2xlYW4gfCB1bmRlZmluZWRcbiAgaXNIb3ZlcmVkOiBib29sZWFuXG4gIGlzSGFsZkhvdmVyZWQ/OiBib29sZWFuIHwgdW5kZWZpbmVkXG4gIGNsaWNrOiBGdW5jdGlvblxufVxuXG4vKiBAdnVlL2NvbXBvbmVudCAqL1xuZXhwb3J0IGRlZmF1bHQgbWl4aW5zKFxuICBDb2xvcmFibGUsXG4gIERlbGF5YWJsZSxcbiAgUmlwcGxlYWJsZSxcbiAgU2l6ZWFibGUsXG4gIFRoZW1lYWJsZVxuKS5leHRlbmQoe1xuICBuYW1lOiAndi1yYXRpbmcnLFxuXG4gIHByb3BzOiB7XG4gICAgYmFja2dyb3VuZENvbG9yOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnYWNjZW50JyxcbiAgICB9LFxuICAgIGNvbG9yOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAncHJpbWFyeScsXG4gICAgfSxcbiAgICBjbGVhcmFibGU6IEJvb2xlYW4sXG4gICAgZGVuc2U6IEJvb2xlYW4sXG4gICAgZW1wdHlJY29uOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnJHJhdGluZ0VtcHR5JyxcbiAgICB9LFxuICAgIGZ1bGxJY29uOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnJHJhdGluZ0Z1bGwnLFxuICAgIH0sXG4gICAgaGFsZkljb246IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICckcmF0aW5nSGFsZicsXG4gICAgfSxcbiAgICBoYWxmSW5jcmVtZW50czogQm9vbGVhbixcbiAgICBob3ZlcjogQm9vbGVhbixcbiAgICBsZW5ndGg6IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiA1LFxuICAgIH0sXG4gICAgcmVhZG9ubHk6IEJvb2xlYW4sXG4gICAgc2l6ZTogW051bWJlciwgU3RyaW5nXSxcbiAgICB2YWx1ZToge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgZGVmYXVsdDogMCxcbiAgICB9LFxuICB9LFxuXG4gIGRhdGEgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBob3ZlckluZGV4OiAtMSxcbiAgICAgIGludGVybmFsVmFsdWU6IHRoaXMudmFsdWUsXG4gICAgfVxuICB9LFxuXG4gIGNvbXB1dGVkOiB7XG4gICAgZGlyZWN0aXZlcyAoKTogVk5vZGVEaXJlY3RpdmVbXSB7XG4gICAgICBpZiAodGhpcy5yZWFkb25seSB8fCAhdGhpcy5yaXBwbGUpIHJldHVybiBbXVxuXG4gICAgICByZXR1cm4gW3tcbiAgICAgICAgbmFtZTogJ3JpcHBsZScsXG4gICAgICAgIHZhbHVlOiB7IGNpcmNsZTogdHJ1ZSB9LFxuICAgICAgfSBhcyBWTm9kZURpcmVjdGl2ZV1cbiAgICB9LFxuICAgIGljb25Qcm9wcyAoKTogb2JqZWN0IHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgZGFyayxcbiAgICAgICAgbGFyZ2UsXG4gICAgICAgIGxpZ2h0LFxuICAgICAgICBtZWRpdW0sXG4gICAgICAgIHNtYWxsLFxuICAgICAgICBzaXplLFxuICAgICAgICB4TGFyZ2UsXG4gICAgICAgIHhTbWFsbCxcbiAgICAgIH0gPSB0aGlzLiRwcm9wc1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBkYXJrLFxuICAgICAgICBsYXJnZSxcbiAgICAgICAgbGlnaHQsXG4gICAgICAgIG1lZGl1bSxcbiAgICAgICAgc2l6ZSxcbiAgICAgICAgc21hbGwsXG4gICAgICAgIHhMYXJnZSxcbiAgICAgICAgeFNtYWxsLFxuICAgICAgfVxuICAgIH0sXG4gICAgaXNIb3ZlcmluZyAoKTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy5ob3ZlciAmJiB0aGlzLmhvdmVySW5kZXggPj0gMFxuICAgIH0sXG4gIH0sXG5cbiAgd2F0Y2g6IHtcbiAgICBpbnRlcm5hbFZhbHVlICh2YWwpIHtcbiAgICAgIHZhbCAhPT0gdGhpcy52YWx1ZSAmJiB0aGlzLiRlbWl0KCdpbnB1dCcsIHZhbClcbiAgICB9LFxuICAgIHZhbHVlICh2YWwpIHtcbiAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZSA9IHZhbFxuICAgIH0sXG4gIH0sXG5cbiAgbWV0aG9kczoge1xuICAgIGNyZWF0ZUNsaWNrRm4gKGk6IG51bWJlcik6IEZ1bmN0aW9uIHtcbiAgICAgIHJldHVybiAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5yZWFkb25seSkgcmV0dXJuXG5cbiAgICAgICAgY29uc3QgbmV3VmFsdWUgPSB0aGlzLmdlbkhvdmVySW5kZXgoZSwgaSlcbiAgICAgICAgaWYgKHRoaXMuY2xlYXJhYmxlICYmIHRoaXMuaW50ZXJuYWxWYWx1ZSA9PT0gbmV3VmFsdWUpIHtcbiAgICAgICAgICB0aGlzLmludGVybmFsVmFsdWUgPSAwXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5pbnRlcm5hbFZhbHVlID0gbmV3VmFsdWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgY3JlYXRlUHJvcHMgKGk6IG51bWJlcik6IEl0ZW1TbG90UHJvcHMge1xuICAgICAgY29uc3QgcHJvcHM6IEl0ZW1TbG90UHJvcHMgPSB7XG4gICAgICAgIGluZGV4OiBpLFxuICAgICAgICB2YWx1ZTogdGhpcy5pbnRlcm5hbFZhbHVlLFxuICAgICAgICBjbGljazogdGhpcy5jcmVhdGVDbGlja0ZuKGkpLFxuICAgICAgICBpc0ZpbGxlZDogTWF0aC5mbG9vcih0aGlzLmludGVybmFsVmFsdWUpID4gaSxcbiAgICAgICAgaXNIb3ZlcmVkOiBNYXRoLmZsb29yKHRoaXMuaG92ZXJJbmRleCkgPiBpLFxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5oYWxmSW5jcmVtZW50cykge1xuICAgICAgICBwcm9wcy5pc0hhbGZIb3ZlcmVkID0gIXByb3BzLmlzSG92ZXJlZCAmJiAodGhpcy5ob3ZlckluZGV4IC0gaSkgJSAxID4gMFxuICAgICAgICBwcm9wcy5pc0hhbGZGaWxsZWQgPSAhcHJvcHMuaXNGaWxsZWQgJiYgKHRoaXMuaW50ZXJuYWxWYWx1ZSAtIGkpICUgMSA+IDBcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHByb3BzXG4gICAgfSxcbiAgICBnZW5Ib3ZlckluZGV4IChlOiBNb3VzZUV2ZW50LCBpOiBudW1iZXIpIHtcbiAgICAgIGxldCBpc0hhbGYgPSB0aGlzLmlzSGFsZkV2ZW50KGUpXG5cbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy5oYWxmSW5jcmVtZW50cyAmJlxuICAgICAgICB0aGlzLiR2dWV0aWZ5LnJ0bFxuICAgICAgKSB7XG4gICAgICAgIGlzSGFsZiA9ICFpc0hhbGZcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGkgKyAoaXNIYWxmID8gMC41IDogMSlcbiAgICB9LFxuICAgIGdldEljb25OYW1lIChwcm9wczogSXRlbVNsb3RQcm9wcyk6IHN0cmluZyB7XG4gICAgICBjb25zdCBpc0Z1bGwgPSB0aGlzLmlzSG92ZXJpbmcgPyBwcm9wcy5pc0hvdmVyZWQgOiBwcm9wcy5pc0ZpbGxlZFxuICAgICAgY29uc3QgaXNIYWxmID0gdGhpcy5pc0hvdmVyaW5nID8gcHJvcHMuaXNIYWxmSG92ZXJlZCA6IHByb3BzLmlzSGFsZkZpbGxlZFxuXG4gICAgICByZXR1cm4gaXNGdWxsID8gdGhpcy5mdWxsSWNvbiA6IGlzSGFsZiA/IHRoaXMuaGFsZkljb24gOiB0aGlzLmVtcHR5SWNvblxuICAgIH0sXG4gICAgZ2V0Q29sb3IgKHByb3BzOiBJdGVtU2xvdFByb3BzKTogc3RyaW5nIHtcbiAgICAgIGlmICh0aGlzLmlzSG92ZXJpbmcpIHtcbiAgICAgICAgaWYgKHByb3BzLmlzSG92ZXJlZCB8fCBwcm9wcy5pc0hhbGZIb3ZlcmVkKSByZXR1cm4gdGhpcy5jb2xvclxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHByb3BzLmlzRmlsbGVkIHx8IHByb3BzLmlzSGFsZkZpbGxlZCkgcmV0dXJuIHRoaXMuY29sb3JcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuYmFja2dyb3VuZENvbG9yXG4gICAgfSxcbiAgICBpc0hhbGZFdmVudCAoZTogTW91c2VFdmVudCk6IGJvb2xlYW4ge1xuICAgICAgaWYgKHRoaXMuaGFsZkluY3JlbWVudHMpIHtcbiAgICAgICAgY29uc3QgcmVjdCA9IGUudGFyZ2V0ICYmIChlLnRhcmdldCBhcyBIVE1MRWxlbWVudCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgICAgaWYgKHJlY3QgJiYgKGUucGFnZVggLSByZWN0LmxlZnQpIDwgcmVjdC53aWR0aCAvIDIpIHJldHVybiB0cnVlXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH0sXG4gICAgb25Nb3VzZUVudGVyIChlOiBNb3VzZUV2ZW50LCBpOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgIHRoaXMucnVuRGVsYXkoJ29wZW4nLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuaG92ZXJJbmRleCA9IHRoaXMuZ2VuSG92ZXJJbmRleChlLCBpKVxuICAgICAgfSlcbiAgICB9LFxuICAgIG9uTW91c2VMZWF2ZSAoKTogdm9pZCB7XG4gICAgICB0aGlzLnJ1bkRlbGF5KCdjbG9zZScsICgpID0+ICh0aGlzLmhvdmVySW5kZXggPSAtMSkpXG4gICAgfSxcbiAgICBnZW5JdGVtIChpOiBudW1iZXIpOiBWTm9kZSB8IFZOb2RlQ2hpbGRyZW4gfCBzdHJpbmcge1xuICAgICAgY29uc3QgcHJvcHMgPSB0aGlzLmNyZWF0ZVByb3BzKGkpXG5cbiAgICAgIGlmICh0aGlzLiRzY29wZWRTbG90cy5pdGVtKSByZXR1cm4gdGhpcy4kc2NvcGVkU2xvdHMuaXRlbShwcm9wcylcblxuICAgICAgY29uc3QgbGlzdGVuZXJzOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbj4gPSB7XG4gICAgICAgIGNsaWNrOiBwcm9wcy5jbGljayxcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuaG92ZXIpIHtcbiAgICAgICAgbGlzdGVuZXJzLm1vdXNlZW50ZXIgPSAoZTogTW91c2VFdmVudCkgPT4gdGhpcy5vbk1vdXNlRW50ZXIoZSwgaSlcbiAgICAgICAgbGlzdGVuZXJzLm1vdXNlbGVhdmUgPSB0aGlzLm9uTW91c2VMZWF2ZVxuXG4gICAgICAgIGlmICh0aGlzLmhhbGZJbmNyZW1lbnRzKSB7XG4gICAgICAgICAgbGlzdGVuZXJzLm1vdXNlbW92ZSA9IChlOiBNb3VzZUV2ZW50KSA9PiB0aGlzLm9uTW91c2VFbnRlcihlLCBpKVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KFZJY29uLCB0aGlzLnNldFRleHRDb2xvcih0aGlzLmdldENvbG9yKHByb3BzKSwge1xuICAgICAgICBhdHRyczogeyB0YWJpbmRleDogLTEgfSwgLy8gVE9ETzogQWRkIGExMXkgc3VwcG9ydFxuICAgICAgICBkaXJlY3RpdmVzOiB0aGlzLmRpcmVjdGl2ZXMsXG4gICAgICAgIHByb3BzOiB0aGlzLmljb25Qcm9wcyxcbiAgICAgICAgb246IGxpc3RlbmVycyxcbiAgICAgIH0pLCBbdGhpcy5nZXRJY29uTmFtZShwcm9wcyldKVxuICAgIH0sXG4gIH0sXG5cbiAgcmVuZGVyIChoKTogVk5vZGUge1xuICAgIGNvbnN0IGNoaWxkcmVuID0gY3JlYXRlUmFuZ2UoTnVtYmVyKHRoaXMubGVuZ3RoKSkubWFwKGkgPT4gdGhpcy5nZW5JdGVtKGkpKVxuXG4gICAgcmV0dXJuIGgoJ2RpdicsIHtcbiAgICAgIHN0YXRpY0NsYXNzOiAndi1yYXRpbmcnLFxuICAgICAgY2xhc3M6IHtcbiAgICAgICAgJ3YtcmF0aW5nLS1yZWFkb25seSc6IHRoaXMucmVhZG9ubHksXG4gICAgICAgICd2LXJhdGluZy0tZGVuc2UnOiB0aGlzLmRlbnNlLFxuICAgICAgfSxcbiAgICB9LCBjaGlsZHJlbilcbiAgfSxcbn0pXG4iXX0=