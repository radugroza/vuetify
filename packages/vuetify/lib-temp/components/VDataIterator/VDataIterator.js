// Components
import { VData } from '../VData';
import VDataFooter from './VDataFooter';
// Mixins
import Mobile from '../../mixins/mobile';
import Themeable from '../../mixins/themeable';
// Helpers
import mixins from '../../util/mixins';
import { deepEqual, getObjectValueByPath, getPrefixedScopedSlots, getSlot, camelizeObjectKeys } from '../../util/helpers';
import { breaking, removed } from '../../util/console';
/* @vue/component */
export default mixins(Mobile, Themeable).extend({
    name: 'v-data-iterator',
    props: {
        ...VData.options.props,
        itemKey: {
            type: String,
            default: 'id',
        },
        value: {
            type: Array,
            default: () => [],
        },
        singleSelect: Boolean,
        expanded: {
            type: Array,
            default: () => [],
        },
        mobileBreakpoint: {
            ...Mobile.options.props.mobileBreakpoint,
            default: 600,
        },
        singleExpand: Boolean,
        loading: [Boolean, String],
        noResultsText: {
            type: String,
            default: '$vuetify.dataIterator.noResultsText',
        },
        noDataText: {
            type: String,
            default: '$vuetify.noDataText',
        },
        loadingText: {
            type: String,
            default: '$vuetify.dataIterator.loadingText',
        },
        hideDefaultFooter: Boolean,
        footerProps: Object,
        selectableKey: {
            type: String,
            default: 'isSelectable',
        },
    },
    data: () => ({
        selection: {},
        expansion: {},
        internalCurrentItems: [],
    }),
    computed: {
        everyItem() {
            return !!this.selectableItems.length && this.selectableItems.every((i) => this.isSelected(i));
        },
        someItems() {
            return this.selectableItems.some((i) => this.isSelected(i));
        },
        sanitizedFooterProps() {
            return camelizeObjectKeys(this.footerProps);
        },
        selectableItems() {
            return this.internalCurrentItems.filter(item => this.isSelectable(item));
        },
    },
    watch: {
        value: {
            handler(value) {
                this.selection = value.reduce((selection, item) => {
                    selection[getObjectValueByPath(item, this.itemKey)] = item;
                    return selection;
                }, {});
            },
            immediate: true,
        },
        selection(value, old) {
            if (deepEqual(Object.keys(value), Object.keys(old)))
                return;
            this.$emit('input', Object.values(value));
        },
        expanded: {
            handler(value) {
                this.expansion = value.reduce((expansion, item) => {
                    expansion[getObjectValueByPath(item, this.itemKey)] = true;
                    return expansion;
                }, {});
            },
            immediate: true,
        },
        expansion(value, old) {
            if (deepEqual(value, old))
                return;
            const keys = Object.keys(value).filter(k => value[k]);
            const expanded = !keys.length ? [] : this.items.filter(i => keys.includes(String(getObjectValueByPath(i, this.itemKey))));
            this.$emit('update:expanded', expanded);
        },
    },
    created() {
        const breakingProps = [
            ['disable-initial-sort', 'sort-by'],
            ['filter', 'custom-filter'],
            ['pagination', 'options'],
            ['total-items', 'server-items-length'],
            ['hide-actions', 'hide-default-footer'],
            ['rows-per-page-items', 'footer-props.items-per-page-options'],
            ['rows-per-page-text', 'footer-props.items-per-page-text'],
            ['prev-icon', 'footer-props.prev-icon'],
            ['next-icon', 'footer-props.next-icon'],
        ];
        /* istanbul ignore next */
        breakingProps.forEach(([original, replacement]) => {
            if (this.$attrs.hasOwnProperty(original))
                breaking(original, replacement, this);
        });
        const removedProps = [
            'expand',
            'content-class',
            'content-props',
            'content-tag',
        ];
        /* istanbul ignore next */
        removedProps.forEach(prop => {
            if (this.$attrs.hasOwnProperty(prop))
                removed(prop);
        });
    },
    methods: {
        toggleSelectAll(value) {
            const selection = Object.assign({}, this.selection);
            for (let i = 0; i < this.selectableItems.length; i++) {
                const item = this.selectableItems[i];
                if (!this.isSelectable(item))
                    continue;
                const key = getObjectValueByPath(item, this.itemKey);
                if (value)
                    selection[key] = item;
                else
                    delete selection[key];
            }
            this.selection = selection;
            this.$emit('toggle-select-all', { items: this.internalCurrentItems, value });
        },
        isSelectable(item) {
            return getObjectValueByPath(item, this.selectableKey) !== false;
        },
        isSelected(item) {
            return !!this.selection[getObjectValueByPath(item, this.itemKey)] || false;
        },
        select(item, value = true, emit = true) {
            if (!this.isSelectable(item))
                return;
            const selection = this.singleSelect ? {} : Object.assign({}, this.selection);
            const key = getObjectValueByPath(item, this.itemKey);
            if (value)
                selection[key] = item;
            else
                delete selection[key];
            if (this.singleSelect && emit) {
                const keys = Object.keys(this.selection);
                const old = keys.length && getObjectValueByPath(this.selection[keys[0]], this.itemKey);
                old && old !== key && this.$emit('item-selected', { item: this.selection[old], value: false });
            }
            this.selection = selection;
            emit && this.$emit('item-selected', { item, value });
        },
        isExpanded(item) {
            return this.expansion[getObjectValueByPath(item, this.itemKey)] || false;
        },
        expand(item, value = true) {
            const expansion = this.singleExpand ? {} : Object.assign({}, this.expansion);
            const key = getObjectValueByPath(item, this.itemKey);
            if (value)
                expansion[key] = true;
            else
                delete expansion[key];
            this.expansion = expansion;
            this.$emit('item-expanded', { item, value });
        },
        createItemProps(item) {
            return {
                item,
                select: (v) => this.select(item, v),
                isSelected: this.isSelected(item),
                expand: (v) => this.expand(item, v),
                isExpanded: this.isExpanded(item),
                isMobile: this.isMobile,
            };
        },
        genEmptyWrapper(content) {
            return this.$createElement('div', content);
        },
        genEmpty(originalItemsLength, filteredItemsLength) {
            if (originalItemsLength === 0 && this.loading) {
                const loading = this.$slots['loading'] || this.$vuetify.lang.t(this.loadingText);
                return this.genEmptyWrapper(loading);
            }
            else if (originalItemsLength === 0) {
                const noData = this.$slots['no-data'] || this.$vuetify.lang.t(this.noDataText);
                return this.genEmptyWrapper(noData);
            }
            else if (filteredItemsLength === 0) {
                const noResults = this.$slots['no-results'] || this.$vuetify.lang.t(this.noResultsText);
                return this.genEmptyWrapper(noResults);
            }
            return null;
        },
        genItems(props) {
            const empty = this.genEmpty(props.originalItemsLength, props.pagination.itemsLength);
            if (empty)
                return [empty];
            if (this.$scopedSlots.default) {
                return this.$scopedSlots.default({
                    ...props,
                    isSelected: this.isSelected,
                    select: this.select,
                    isExpanded: this.isExpanded,
                    expand: this.expand,
                });
            }
            if (this.$scopedSlots.item) {
                return props.items.map((item) => this.$scopedSlots.item(this.createItemProps(item)));
            }
            return [];
        },
        genFooter(props) {
            if (this.hideDefaultFooter)
                return null;
            const data = {
                props: {
                    ...this.sanitizedFooterProps,
                    options: props.options,
                    pagination: props.pagination,
                },
                on: {
                    'update:options': (value) => props.updateOptions(value),
                },
            };
            const scopedSlots = getPrefixedScopedSlots('footer.', this.$scopedSlots);
            return this.$createElement(VDataFooter, {
                scopedSlots,
                ...data,
            });
        },
        genDefaultScopedSlot(props) {
            const outerProps = {
                ...props,
                someItems: this.someItems,
                everyItem: this.everyItem,
                toggleSelectAll: this.toggleSelectAll,
            };
            return this.$createElement('div', {
                staticClass: 'v-data-iterator',
            }, [
                getSlot(this, 'header', outerProps, true),
                this.genItems(props),
                this.genFooter(props),
                getSlot(this, 'footer', outerProps, true),
            ]);
        },
    },
    render() {
        return this.$createElement(VData, {
            props: this.$props,
            on: {
                'update:options': (v, old) => !deepEqual(v, old) && this.$emit('update:options', v),
                'update:page': (v) => this.$emit('update:page', v),
                'update:items-per-page': (v) => this.$emit('update:items-per-page', v),
                'update:sort-by': (v) => this.$emit('update:sort-by', v),
                'update:sort-desc': (v) => this.$emit('update:sort-desc', v),
                'update:group-by': (v) => this.$emit('update:group-by', v),
                'update:group-desc': (v) => this.$emit('update:group-desc', v),
                pagination: (v, old) => !deepEqual(v, old) && this.$emit('pagination', v),
                'current-items': (v) => {
                    this.internalCurrentItems = v;
                    this.$emit('current-items', v);
                },
                'page-count': (v) => this.$emit('page-count', v),
            },
            scopedSlots: {
                default: this.genDefaultScopedSlot,
            },
        });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFJdGVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZEYXRhSXRlcmF0b3IvVkRhdGFJdGVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxhQUFhO0FBQ2IsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUNoQyxPQUFPLFdBQVcsTUFBTSxlQUFlLENBQUE7QUFFdkMsU0FBUztBQUNULE9BQU8sTUFBTSxNQUFNLHFCQUFxQixDQUFBO0FBQ3hDLE9BQU8sU0FBUyxNQUFNLHdCQUF3QixDQUFBO0FBRTlDLFVBQVU7QUFDVixPQUFPLE1BQU0sTUFBTSxtQkFBbUIsQ0FBQTtBQUN0QyxPQUFPLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLHNCQUFzQixFQUFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQ3pILE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFNdEQsb0JBQW9CO0FBQ3BCLGVBQWUsTUFBTSxDQUNuQixNQUFNLEVBQ04sU0FBUyxDQUNWLENBQUMsTUFBTSxDQUFDO0lBQ1AsSUFBSSxFQUFFLGlCQUFpQjtJQUV2QixLQUFLLEVBQUU7UUFDTCxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSztRQUN0QixPQUFPLEVBQUU7WUFDUCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxJQUFJO1NBQ2Q7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsS0FBd0I7WUFDOUIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUU7U0FDbEI7UUFDRCxZQUFZLEVBQUUsT0FBTztRQUNyQixRQUFRLEVBQUU7WUFDUixJQUFJLEVBQUUsS0FBd0I7WUFDOUIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUU7U0FDbEI7UUFDRCxnQkFBZ0IsRUFBRTtZQUNoQixHQUFHLE1B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LElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO2dCQUNuRixlQUFlLEVBQUUsQ0FBQyxDQUFRLEVBQUUsRUFBRTtvQkFDNUIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLENBQUMsQ0FBQTtvQkFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUE7Z0JBQ2hDLENBQUM7Z0JBQ0QsWUFBWSxFQUFFLENBQUMsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7YUFDekQ7WUFDRCxXQUFXLEVBQUU7Z0JBQ1gsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0I7YUFDbkM7U0FDRixDQUFDLENBQUE7SUFDSixDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29tcG9uZW50c1xuaW1wb3J0IHsgVkRhdGEgfSBmcm9tICcuLi9WRGF0YSdcbmltcG9ydCBWRGF0YUZvb3RlciBmcm9tICcuL1ZEYXRhRm9vdGVyJ1xuXG4vLyBNaXhpbnNcbmltcG9ydCBNb2JpbGUgZnJvbSAnLi4vLi4vbWl4aW5zL21vYmlsZSdcbmltcG9ydCBUaGVtZWFibGUgZnJvbSAnLi4vLi4vbWl4aW5zL3RoZW1lYWJsZSdcblxuLy8gSGVscGVyc1xuaW1wb3J0IG1peGlucyBmcm9tICcuLi8uLi91dGlsL21peGlucydcbmltcG9ydCB7IGRlZXBFcXVhbCwgZ2V0T2JqZWN0VmFsdWVCeVBhdGgsIGdldFByZWZpeGVkU2NvcGVkU2xvdHMsIGdldFNsb3QsIGNhbWVsaXplT2JqZWN0S2V5cyB9IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycydcbmltcG9ydCB7IGJyZWFraW5nLCByZW1vdmVkIH0gZnJvbSAnLi4vLi4vdXRpbC9jb25zb2xlJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUsIFZOb2RlQ2hpbGRyZW4sIFByb3BUeXBlIH0gZnJvbSAndnVlJ1xuaW1wb3J0IHsgRGF0YUl0ZW1Qcm9wcywgRGF0YVNjb3BlUHJvcHMgfSBmcm9tICd2dWV0aWZ5L3R5cGVzJ1xuXG4vKiBAdnVlL2NvbXBvbmVudCAqL1xuZXhwb3J0IGRlZmF1bHQgbWl4aW5zKFxuICBNb2JpbGUsXG4gIFRoZW1lYWJsZVxuKS5leHRlbmQoe1xuICBuYW1lOiAndi1kYXRhLWl0ZXJhdG9yJyxcblxuICBwcm9wczoge1xuICAgIC4uLlZEYXRhLm9wdGlvbnMucHJvcHMsIC8vIFRPRE86IGZpbHRlciBvdXQgcHJvcHMgbm90IHVzZWRcbiAgICBpdGVtS2V5OiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnaWQnLFxuICAgIH0sXG4gICAgdmFsdWU6IHtcbiAgICAgIHR5cGU6IEFycmF5IGFzIFByb3BUeXBlPGFueVtdPixcbiAgICAgIGRlZmF1bHQ6ICgpID0+IFtdLFxuICAgIH0sXG4gICAgc2luZ2xlU2VsZWN0OiBCb29sZWFuLFxuICAgIGV4cGFuZGVkOiB7XG4gICAgICB0eXBlOiBBcnJheSBhcyBQcm9wVHlwZTxhbnlbXT4sXG4gICAgICBkZWZhdWx0OiAoKSA9PiBbXSxcbiAgICB9LFxuICAgIG1vYmlsZUJyZWFrcG9pbnQ6IHtcbiAgICAgIC4uLk1vYmlsZS5vcHRpb25zLnByb3BzLm1vYmlsZUJyZWFrcG9pbnQsXG4gICAgICBkZWZhdWx0OiA2MDAsXG4gICAgfSxcbiAgICBzaW5nbGVFeHBhbmQ6IEJvb2xlYW4sXG4gICAgbG9hZGluZzogW0Jvb2xlYW4sIFN0cmluZ10sXG4gICAgbm9SZXN1bHRzVGV4dDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJyR2dWV0aWZ5LmRhdGFJdGVyYXRvci5ub1Jlc3VsdHNUZXh0JyxcbiAgICB9LFxuICAgIG5vRGF0YVRleHQ6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICckdnVldGlmeS5ub0RhdGFUZXh0JyxcbiAgICB9LFxuICAgIGxvYWRpbmdUZXh0OiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnJHZ1ZXRpZnkuZGF0YUl0ZXJhdG9yLmxvYWRpbmdUZXh0JyxcbiAgICB9LFxuICAgIGhpZGVEZWZhdWx0Rm9vdGVyOiBCb29sZWFuLFxuICAgIGZvb3RlclByb3BzOiBPYmplY3QsXG4gICAgc2VsZWN0YWJsZUtleToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJ2lzU2VsZWN0YWJsZScsXG4gICAgfSxcbiAgfSxcblxuICBkYXRhOiAoKSA9PiAoe1xuICAgIHNlbGVjdGlvbjoge30gYXMgUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBleHBhbnNpb246IHt9IGFzIFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+LFxuICAgIGludGVybmFsQ3VycmVudEl0ZW1zOiBbXSBhcyBhbnlbXSxcbiAgfSksXG5cbiAgY29tcHV0ZWQ6IHtcbiAgICBldmVyeUl0ZW0gKCk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuICEhdGhpcy5zZWxlY3RhYmxlSXRlbXMubGVuZ3RoICYmIHRoaXMuc2VsZWN0YWJsZUl0ZW1zLmV2ZXJ5KChpOiBhbnkpID0+IHRoaXMuaXNTZWxlY3RlZChpKSlcbiAgICB9LFxuICAgIHNvbWVJdGVtcyAoKTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy5zZWxlY3RhYmxlSXRlbXMuc29tZSgoaTogYW55KSA9PiB0aGlzLmlzU2VsZWN0ZWQoaSkpXG4gICAgfSxcbiAgICBzYW5pdGl6ZWRGb290ZXJQcm9wcyAoKTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgICByZXR1cm4gY2FtZWxpemVPYmplY3RLZXlzKHRoaXMuZm9vdGVyUHJvcHMpXG4gICAgfSxcbiAgICBzZWxlY3RhYmxlSXRlbXMgKCk6IGFueVtdIHtcbiAgICAgIHJldHVybiB0aGlzLmludGVybmFsQ3VycmVudEl0ZW1zLmZpbHRlcihpdGVtID0+IHRoaXMuaXNTZWxlY3RhYmxlKGl0ZW0pKVxuICAgIH0sXG4gIH0sXG5cbiAgd2F0Y2g6IHtcbiAgICB2YWx1ZToge1xuICAgICAgaGFuZGxlciAodmFsdWU6IGFueVtdKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0aW9uID0gdmFsdWUucmVkdWNlKChzZWxlY3Rpb24sIGl0ZW0pID0+IHtcbiAgICAgICAgICBzZWxlY3Rpb25bZ2V0T2JqZWN0VmFsdWVCeVBhdGgoaXRlbSwgdGhpcy5pdGVtS2V5KV0gPSBpdGVtXG4gICAgICAgICAgcmV0dXJuIHNlbGVjdGlvblxuICAgICAgICB9LCB7fSlcbiAgICAgIH0sXG4gICAgICBpbW1lZGlhdGU6IHRydWUsXG4gICAgfSxcbiAgICBzZWxlY3Rpb24gKHZhbHVlOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiwgb2xkOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPikge1xuICAgICAgaWYgKGRlZXBFcXVhbChPYmplY3Qua2V5cyh2YWx1ZSksIE9iamVjdC5rZXlzKG9sZCkpKSByZXR1cm5cblxuICAgICAgdGhpcy4kZW1pdCgnaW5wdXQnLCBPYmplY3QudmFsdWVzKHZhbHVlKSlcbiAgICB9LFxuICAgIGV4cGFuZGVkOiB7XG4gICAgICBoYW5kbGVyICh2YWx1ZTogYW55W10pIHtcbiAgICAgICAgdGhpcy5leHBhbnNpb24gPSB2YWx1ZS5yZWR1Y2UoKGV4cGFuc2lvbiwgaXRlbSkgPT4ge1xuICAgICAgICAgIGV4cGFuc2lvbltnZXRPYmplY3RWYWx1ZUJ5UGF0aChpdGVtLCB0aGlzLml0ZW1LZXkpXSA9IHRydWVcbiAgICAgICAgICByZXR1cm4gZXhwYW5zaW9uXG4gICAgICAgIH0sIHt9KVxuICAgICAgfSxcbiAgICAgIGltbWVkaWF0ZTogdHJ1ZSxcbiAgICB9LFxuICAgIGV4cGFuc2lvbiAodmFsdWU6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+LCBvbGQ6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+KSB7XG4gICAgICBpZiAoZGVlcEVxdWFsKHZhbHVlLCBvbGQpKSByZXR1cm5cbiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSkuZmlsdGVyKGsgPT4gdmFsdWVba10pXG4gICAgICBjb25zdCBleHBhbmRlZCA9ICFrZXlzLmxlbmd0aCA/IFtdIDogdGhpcy5pdGVtcy5maWx0ZXIoaSA9PiBrZXlzLmluY2x1ZGVzKFN0cmluZyhnZXRPYmplY3RWYWx1ZUJ5UGF0aChpLCB0aGlzLml0ZW1LZXkpKSkpXG4gICAgICB0aGlzLiRlbWl0KCd1cGRhdGU6ZXhwYW5kZWQnLCBleHBhbmRlZClcbiAgICB9LFxuICB9LFxuXG4gIGNyZWF0ZWQgKCkge1xuICAgIGNvbnN0IGJyZWFraW5nUHJvcHMgPSBbXG4gICAgICBbJ2Rpc2FibGUtaW5pdGlhbC1zb3J0JywgJ3NvcnQtYnknXSxcbiAgICAgIFsnZmlsdGVyJywgJ2N1c3RvbS1maWx0ZXInXSxcbiAgICAgIFsncGFnaW5hdGlvbicsICdvcHRpb25zJ10sXG4gICAgICBbJ3RvdGFsLWl0ZW1zJywgJ3NlcnZlci1pdGVtcy1sZW5ndGgnXSxcbiAgICAgIFsnaGlkZS1hY3Rpb25zJywgJ2hpZGUtZGVmYXVsdC1mb290ZXInXSxcbiAgICAgIFsncm93cy1wZXItcGFnZS1pdGVtcycsICdmb290ZXItcHJvcHMuaXRlbXMtcGVyLXBhZ2Utb3B0aW9ucyddLFxuICAgICAgWydyb3dzLXBlci1wYWdlLXRleHQnLCAnZm9vdGVyLXByb3BzLml0ZW1zLXBlci1wYWdlLXRleHQnXSxcbiAgICAgIFsncHJldi1pY29uJywgJ2Zvb3Rlci1wcm9wcy5wcmV2LWljb24nXSxcbiAgICAgIFsnbmV4dC1pY29uJywgJ2Zvb3Rlci1wcm9wcy5uZXh0LWljb24nXSxcbiAgICBdXG5cbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIGJyZWFraW5nUHJvcHMuZm9yRWFjaCgoW29yaWdpbmFsLCByZXBsYWNlbWVudF0pID0+IHtcbiAgICAgIGlmICh0aGlzLiRhdHRycy5oYXNPd25Qcm9wZXJ0eShvcmlnaW5hbCkpIGJyZWFraW5nKG9yaWdpbmFsLCByZXBsYWNlbWVudCwgdGhpcylcbiAgICB9KVxuXG4gICAgY29uc3QgcmVtb3ZlZFByb3BzID0gW1xuICAgICAgJ2V4cGFuZCcsXG4gICAgICAnY29udGVudC1jbGFzcycsXG4gICAgICAnY29udGVudC1wcm9wcycsXG4gICAgICAnY29udGVudC10YWcnLFxuICAgIF1cblxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgcmVtb3ZlZFByb3BzLmZvckVhY2gocHJvcCA9PiB7XG4gICAgICBpZiAodGhpcy4kYXR0cnMuaGFzT3duUHJvcGVydHkocHJvcCkpIHJlbW92ZWQocHJvcClcbiAgICB9KVxuICB9LFxuXG4gIG1ldGhvZHM6IHtcbiAgICB0b2dnbGVTZWxlY3RBbGwgKHZhbHVlOiBib29sZWFuKTogdm9pZCB7XG4gICAgICBjb25zdCBzZWxlY3Rpb24gPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLnNlbGVjdGlvbilcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNlbGVjdGFibGVJdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5zZWxlY3RhYmxlSXRlbXNbaV1cblxuICAgICAgICBpZiAoIXRoaXMuaXNTZWxlY3RhYmxlKGl0ZW0pKSBjb250aW51ZVxuXG4gICAgICAgIGNvbnN0IGtleSA9IGdldE9iamVjdFZhbHVlQnlQYXRoKGl0ZW0sIHRoaXMuaXRlbUtleSlcbiAgICAgICAgaWYgKHZhbHVlKSBzZWxlY3Rpb25ba2V5XSA9IGl0ZW1cbiAgICAgICAgZWxzZSBkZWxldGUgc2VsZWN0aW9uW2tleV1cbiAgICAgIH1cblxuICAgICAgdGhpcy5zZWxlY3Rpb24gPSBzZWxlY3Rpb25cbiAgICAgIHRoaXMuJGVtaXQoJ3RvZ2dsZS1zZWxlY3QtYWxsJywgeyBpdGVtczogdGhpcy5pbnRlcm5hbEN1cnJlbnRJdGVtcywgdmFsdWUgfSlcbiAgICB9LFxuICAgIGlzU2VsZWN0YWJsZSAoaXRlbTogYW55KTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gZ2V0T2JqZWN0VmFsdWVCeVBhdGgoaXRlbSwgdGhpcy5zZWxlY3RhYmxlS2V5KSAhPT0gZmFsc2VcbiAgICB9LFxuICAgIGlzU2VsZWN0ZWQgKGl0ZW06IGFueSk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuICEhdGhpcy5zZWxlY3Rpb25bZ2V0T2JqZWN0VmFsdWVCeVBhdGgoaXRlbSwgdGhpcy5pdGVtS2V5KV0gfHwgZmFsc2VcbiAgICB9LFxuICAgIHNlbGVjdCAoaXRlbTogYW55LCB2YWx1ZSA9IHRydWUsIGVtaXQgPSB0cnVlKTogdm9pZCB7XG4gICAgICBpZiAoIXRoaXMuaXNTZWxlY3RhYmxlKGl0ZW0pKSByZXR1cm5cblxuICAgICAgY29uc3Qgc2VsZWN0aW9uID0gdGhpcy5zaW5nbGVTZWxlY3QgPyB7fSA6IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuc2VsZWN0aW9uKVxuICAgICAgY29uc3Qga2V5ID0gZ2V0T2JqZWN0VmFsdWVCeVBhdGgoaXRlbSwgdGhpcy5pdGVtS2V5KVxuXG4gICAgICBpZiAodmFsdWUpIHNlbGVjdGlvbltrZXldID0gaXRlbVxuICAgICAgZWxzZSBkZWxldGUgc2VsZWN0aW9uW2tleV1cblxuICAgICAgaWYgKHRoaXMuc2luZ2xlU2VsZWN0ICYmIGVtaXQpIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuc2VsZWN0aW9uKVxuICAgICAgICBjb25zdCBvbGQgPSBrZXlzLmxlbmd0aCAmJiBnZXRPYmplY3RWYWx1ZUJ5UGF0aCh0aGlzLnNlbGVjdGlvbltrZXlzWzBdXSwgdGhpcy5pdGVtS2V5KVxuICAgICAgICBvbGQgJiYgb2xkICE9PSBrZXkgJiYgdGhpcy4kZW1pdCgnaXRlbS1zZWxlY3RlZCcsIHsgaXRlbTogdGhpcy5zZWxlY3Rpb25bb2xkXSwgdmFsdWU6IGZhbHNlIH0pXG4gICAgICB9XG4gICAgICB0aGlzLnNlbGVjdGlvbiA9IHNlbGVjdGlvblxuICAgICAgZW1pdCAmJiB0aGlzLiRlbWl0KCdpdGVtLXNlbGVjdGVkJywgeyBpdGVtLCB2YWx1ZSB9KVxuICAgIH0sXG4gICAgaXNFeHBhbmRlZCAoaXRlbTogYW55KTogYm9vbGVhbiB7XG4gICAgICByZXR1cm4gdGhpcy5leHBhbnNpb25bZ2V0T2JqZWN0VmFsdWVCeVBhdGgoaXRlbSwgdGhpcy5pdGVtS2V5KV0gfHwgZmFsc2VcbiAgICB9LFxuICAgIGV4cGFuZCAoaXRlbTogYW55LCB2YWx1ZSA9IHRydWUpOiB2b2lkIHtcbiAgICAgIGNvbnN0IGV4cGFuc2lvbiA9IHRoaXMuc2luZ2xlRXhwYW5kID8ge30gOiBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmV4cGFuc2lvbilcbiAgICAgIGNvbnN0IGtleSA9IGdldE9iamVjdFZhbHVlQnlQYXRoKGl0ZW0sIHRoaXMuaXRlbUtleSlcblxuICAgICAgaWYgKHZhbHVlKSBleHBhbnNpb25ba2V5XSA9IHRydWVcbiAgICAgIGVsc2UgZGVsZXRlIGV4cGFuc2lvbltrZXldXG5cbiAgICAgIHRoaXMuZXhwYW5zaW9uID0gZXhwYW5zaW9uXG4gICAgICB0aGlzLiRlbWl0KCdpdGVtLWV4cGFuZGVkJywgeyBpdGVtLCB2YWx1ZSB9KVxuICAgIH0sXG4gICAgY3JlYXRlSXRlbVByb3BzIChpdGVtOiBhbnkpOiBEYXRhSXRlbVByb3BzIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGl0ZW0sXG4gICAgICAgIHNlbGVjdDogKHY6IGJvb2xlYW4pID0+IHRoaXMuc2VsZWN0KGl0ZW0sIHYpLFxuICAgICAgICBpc1NlbGVjdGVkOiB0aGlzLmlzU2VsZWN0ZWQoaXRlbSksXG4gICAgICAgIGV4cGFuZDogKHY6IGJvb2xlYW4pID0+IHRoaXMuZXhwYW5kKGl0ZW0sIHYpLFxuICAgICAgICBpc0V4cGFuZGVkOiB0aGlzLmlzRXhwYW5kZWQoaXRlbSksXG4gICAgICAgIGlzTW9iaWxlOiB0aGlzLmlzTW9iaWxlLFxuICAgICAgfVxuICAgIH0sXG4gICAgZ2VuRW1wdHlXcmFwcGVyIChjb250ZW50OiBWTm9kZUNoaWxkcmVuKSB7XG4gICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgnZGl2JywgY29udGVudClcbiAgICB9LFxuICAgIGdlbkVtcHR5IChvcmlnaW5hbEl0ZW1zTGVuZ3RoOiBudW1iZXIsIGZpbHRlcmVkSXRlbXNMZW5ndGg6IG51bWJlcikge1xuICAgICAgaWYgKG9yaWdpbmFsSXRlbXNMZW5ndGggPT09IDAgJiYgdGhpcy5sb2FkaW5nKSB7XG4gICAgICAgIGNvbnN0IGxvYWRpbmcgPSB0aGlzLiRzbG90c1snbG9hZGluZyddIHx8IHRoaXMuJHZ1ZXRpZnkubGFuZy50KHRoaXMubG9hZGluZ1RleHQpXG4gICAgICAgIHJldHVybiB0aGlzLmdlbkVtcHR5V3JhcHBlcihsb2FkaW5nKVxuICAgICAgfSBlbHNlIGlmIChvcmlnaW5hbEl0ZW1zTGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnN0IG5vRGF0YSA9IHRoaXMuJHNsb3RzWyduby1kYXRhJ10gfHwgdGhpcy4kdnVldGlmeS5sYW5nLnQodGhpcy5ub0RhdGFUZXh0KVxuICAgICAgICByZXR1cm4gdGhpcy5nZW5FbXB0eVdyYXBwZXIobm9EYXRhKVxuICAgICAgfSBlbHNlIGlmIChmaWx0ZXJlZEl0ZW1zTGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnN0IG5vUmVzdWx0cyA9IHRoaXMuJHNsb3RzWyduby1yZXN1bHRzJ10gfHwgdGhpcy4kdnVldGlmeS5sYW5nLnQodGhpcy5ub1Jlc3VsdHNUZXh0KVxuICAgICAgICByZXR1cm4gdGhpcy5nZW5FbXB0eVdyYXBwZXIobm9SZXN1bHRzKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gbnVsbFxuICAgIH0sXG4gICAgZ2VuSXRlbXMgKHByb3BzOiBEYXRhU2NvcGVQcm9wcykge1xuICAgICAgY29uc3QgZW1wdHkgPSB0aGlzLmdlbkVtcHR5KHByb3BzLm9yaWdpbmFsSXRlbXNMZW5ndGgsIHByb3BzLnBhZ2luYXRpb24uaXRlbXNMZW5ndGgpXG4gICAgICBpZiAoZW1wdHkpIHJldHVybiBbZW1wdHldXG5cbiAgICAgIGlmICh0aGlzLiRzY29wZWRTbG90cy5kZWZhdWx0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRzY29wZWRTbG90cy5kZWZhdWx0KHtcbiAgICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgICBpc1NlbGVjdGVkOiB0aGlzLmlzU2VsZWN0ZWQsXG4gICAgICAgICAgc2VsZWN0OiB0aGlzLnNlbGVjdCxcbiAgICAgICAgICBpc0V4cGFuZGVkOiB0aGlzLmlzRXhwYW5kZWQsXG4gICAgICAgICAgZXhwYW5kOiB0aGlzLmV4cGFuZCxcbiAgICAgICAgfSlcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuJHNjb3BlZFNsb3RzLml0ZW0pIHtcbiAgICAgICAgcmV0dXJuIHByb3BzLml0ZW1zLm1hcCgoaXRlbTogYW55KSA9PiB0aGlzLiRzY29wZWRTbG90cy5pdGVtISh0aGlzLmNyZWF0ZUl0ZW1Qcm9wcyhpdGVtKSkpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBbXVxuICAgIH0sXG4gICAgZ2VuRm9vdGVyIChwcm9wczogRGF0YVNjb3BlUHJvcHMpIHtcbiAgICAgIGlmICh0aGlzLmhpZGVEZWZhdWx0Rm9vdGVyKSByZXR1cm4gbnVsbFxuXG4gICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICBwcm9wczoge1xuICAgICAgICAgIC4uLnRoaXMuc2FuaXRpemVkRm9vdGVyUHJvcHMsXG4gICAgICAgICAgb3B0aW9uczogcHJvcHMub3B0aW9ucyxcbiAgICAgICAgICBwYWdpbmF0aW9uOiBwcm9wcy5wYWdpbmF0aW9uLFxuICAgICAgICB9LFxuICAgICAgICBvbjoge1xuICAgICAgICAgICd1cGRhdGU6b3B0aW9ucyc6ICh2YWx1ZTogYW55KSA9PiBwcm9wcy51cGRhdGVPcHRpb25zKHZhbHVlKSxcbiAgICAgICAgfSxcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2NvcGVkU2xvdHMgPSBnZXRQcmVmaXhlZFNjb3BlZFNsb3RzKCdmb290ZXIuJywgdGhpcy4kc2NvcGVkU2xvdHMpXG5cbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KFZEYXRhRm9vdGVyLCB7XG4gICAgICAgIHNjb3BlZFNsb3RzLFxuICAgICAgICAuLi5kYXRhLFxuICAgICAgfSlcbiAgICB9LFxuICAgIGdlbkRlZmF1bHRTY29wZWRTbG90IChwcm9wczogYW55KSB7XG4gICAgICBjb25zdCBvdXRlclByb3BzID0ge1xuICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgc29tZUl0ZW1zOiB0aGlzLnNvbWVJdGVtcyxcbiAgICAgICAgZXZlcnlJdGVtOiB0aGlzLmV2ZXJ5SXRlbSxcbiAgICAgICAgdG9nZ2xlU2VsZWN0QWxsOiB0aGlzLnRvZ2dsZVNlbGVjdEFsbCxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHtcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LWRhdGEtaXRlcmF0b3InLFxuICAgICAgfSwgW1xuICAgICAgICBnZXRTbG90KHRoaXMsICdoZWFkZXInLCBvdXRlclByb3BzLCB0cnVlKSxcbiAgICAgICAgdGhpcy5nZW5JdGVtcyhwcm9wcyksXG4gICAgICAgIHRoaXMuZ2VuRm9vdGVyKHByb3BzKSxcbiAgICAgICAgZ2V0U2xvdCh0aGlzLCAnZm9vdGVyJywgb3V0ZXJQcm9wcywgdHJ1ZSksXG4gICAgICBdKVxuICAgIH0sXG4gIH0sXG5cbiAgcmVuZGVyICgpOiBWTm9kZSB7XG4gICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoVkRhdGEsIHtcbiAgICAgIHByb3BzOiB0aGlzLiRwcm9wcyxcbiAgICAgIG9uOiB7XG4gICAgICAgICd1cGRhdGU6b3B0aW9ucyc6ICh2OiBhbnksIG9sZDogYW55KSA9PiAhZGVlcEVxdWFsKHYsIG9sZCkgJiYgdGhpcy4kZW1pdCgndXBkYXRlOm9wdGlvbnMnLCB2KSxcbiAgICAgICAgJ3VwZGF0ZTpwYWdlJzogKHY6IGFueSkgPT4gdGhpcy4kZW1pdCgndXBkYXRlOnBhZ2UnLCB2KSxcbiAgICAgICAgJ3VwZGF0ZTppdGVtcy1wZXItcGFnZSc6ICh2OiBhbnkpID0+IHRoaXMuJGVtaXQoJ3VwZGF0ZTppdGVtcy1wZXItcGFnZScsIHYpLFxuICAgICAgICAndXBkYXRlOnNvcnQtYnknOiAodjogYW55KSA9PiB0aGlzLiRlbWl0KCd1cGRhdGU6c29ydC1ieScsIHYpLFxuICAgICAgICAndXBkYXRlOnNvcnQtZGVzYyc6ICh2OiBhbnkpID0+IHRoaXMuJGVtaXQoJ3VwZGF0ZTpzb3J0LWRlc2MnLCB2KSxcbiAgICAgICAgJ3VwZGF0ZTpncm91cC1ieSc6ICh2OiBhbnkpID0+IHRoaXMuJGVtaXQoJ3VwZGF0ZTpncm91cC1ieScsIHYpLFxuICAgICAgICAndXBkYXRlOmdyb3VwLWRlc2MnOiAodjogYW55KSA9PiB0aGlzLiRlbWl0KCd1cGRhdGU6Z3JvdXAtZGVzYycsIHYpLFxuICAgICAgICBwYWdpbmF0aW9uOiAodjogYW55LCBvbGQ6IGFueSkgPT4gIWRlZXBFcXVhbCh2LCBvbGQpICYmIHRoaXMuJGVtaXQoJ3BhZ2luYXRpb24nLCB2KSxcbiAgICAgICAgJ2N1cnJlbnQtaXRlbXMnOiAodjogYW55W10pID0+IHtcbiAgICAgICAgICB0aGlzLmludGVybmFsQ3VycmVudEl0ZW1zID0gdlxuICAgICAgICAgIHRoaXMuJGVtaXQoJ2N1cnJlbnQtaXRlbXMnLCB2KVxuICAgICAgICB9LFxuICAgICAgICAncGFnZS1jb3VudCc6ICh2OiBudW1iZXIpID0+IHRoaXMuJGVtaXQoJ3BhZ2UtY291bnQnLCB2KSxcbiAgICAgIH0sXG4gICAgICBzY29wZWRTbG90czoge1xuICAgICAgICBkZWZhdWx0OiB0aGlzLmdlbkRlZmF1bHRTY29wZWRTbG90LFxuICAgICAgfSxcbiAgICB9KVxuICB9LFxufSlcbiJdfQ==