// Styles
import './VRipple.sass';
// Utilities
import { consoleWarn } from '../../util/console';
import { keyCodes } from '../../util/helpers';
const DELAY_RIPPLE = 80;
function transform(el, value) {
    el.style['transform'] = value;
    el.style['webkitTransform'] = value;
}
function opacity(el, value) {
    el.style['opacity'] = value.toString();
}
function isTouchEvent(e) {
    return e.constructor.name === 'TouchEvent';
}
function isKeyboardEvent(e) {
    return e.constructor.name === 'KeyboardEvent';
}
const calculate = (e, el, value = {}) => {
    let localX = 0;
    let localY = 0;
    if (!isKeyboardEvent(e)) {
        const offset = el.getBoundingClientRect();
        const target = isTouchEvent(e) ? e.touches[e.touches.length - 1] : e;
        localX = target.clientX - offset.left;
        localY = target.clientY - offset.top;
    }
    let radius = 0;
    let scale = 0.3;
    if (el._ripple && el._ripple.circle) {
        scale = 0.15;
        radius = el.clientWidth / 2;
        radius = value.center ? radius : radius + Math.sqrt((localX - radius) ** 2 + (localY - radius) ** 2) / 4;
    }
    else {
        radius = Math.sqrt(el.clientWidth ** 2 + el.clientHeight ** 2) / 2;
    }
    const centerX = `${(el.clientWidth - (radius * 2)) / 2}px`;
    const centerY = `${(el.clientHeight - (radius * 2)) / 2}px`;
    const x = value.center ? centerX : `${localX - radius}px`;
    const y = value.center ? centerY : `${localY - radius}px`;
    return { radius, scale, x, y, centerX, centerY };
};
const ripples = {
    /* eslint-disable max-statements */
    show(e, el, value = {}) {
        if (!el._ripple || !el._ripple.enabled) {
            return;
        }
        const container = document.createElement('span');
        const animation = document.createElement('span');
        container.appendChild(animation);
        container.className = 'v-ripple__container';
        if (value.class) {
            container.className += ` ${value.class}`;
        }
        const { radius, scale, x, y, centerX, centerY } = calculate(e, el, value);
        const size = `${radius * 2}px`;
        animation.className = 'v-ripple__animation';
        animation.style.width = size;
        animation.style.height = size;
        el.appendChild(container);
        const computed = window.getComputedStyle(el);
        if (computed && computed.position === 'static') {
            el.style.position = 'relative';
            el.dataset.previousPosition = 'static';
        }
        animation.classList.add('v-ripple__animation--enter');
        animation.classList.add('v-ripple__animation--visible');
        transform(animation, `translate(${x}, ${y}) scale3d(${scale},${scale},${scale})`);
        opacity(animation, 0);
        animation.dataset.activated = String(performance.now());
        setTimeout(() => {
            animation.classList.remove('v-ripple__animation--enter');
            animation.classList.add('v-ripple__animation--in');
            transform(animation, `translate(${centerX}, ${centerY}) scale3d(1,1,1)`);
            opacity(animation, 0.25);
        }, 0);
    },
    hide(el) {
        if (!el || !el._ripple || !el._ripple.enabled)
            return;
        const ripples = el.getElementsByClassName('v-ripple__animation');
        if (ripples.length === 0)
            return;
        const animation = ripples[ripples.length - 1];
        if (animation.dataset.isHiding)
            return;
        else
            animation.dataset.isHiding = 'true';
        const diff = performance.now() - Number(animation.dataset.activated);
        const delay = Math.max(250 - diff, 0);
        setTimeout(() => {
            animation.classList.remove('v-ripple__animation--in');
            animation.classList.add('v-ripple__animation--out');
            opacity(animation, 0);
            setTimeout(() => {
                const ripples = el.getElementsByClassName('v-ripple__animation');
                if (ripples.length === 1 && el.dataset.previousPosition) {
                    el.style.position = el.dataset.previousPosition;
                    delete el.dataset.previousPosition;
                }
                animation.parentNode && el.removeChild(animation.parentNode);
            }, 300);
        }, delay);
    },
};
function isRippleEnabled(value) {
    return typeof value === 'undefined' || !!value;
}
function rippleShow(e) {
    const value = {};
    const element = e.currentTarget;
    if (!element || !element._ripple || element._ripple.touched)
        return;
    if (isTouchEvent(e)) {
        element._ripple.touched = true;
        element._ripple.isTouch = true;
    }
    else {
        // It's possible for touch events to fire
        // as mouse events on Android/iOS, this
        // will skip the event call if it has
        // already been registered as touch
        if (element._ripple.isTouch)
            return;
    }
    value.center = element._ripple.centered || isKeyboardEvent(e);
    if (element._ripple.class) {
        value.class = element._ripple.class;
    }
    if (isTouchEvent(e)) {
        // already queued that shows or hides the ripple
        if (element._ripple.showTimerCommit)
            return;
        element._ripple.showTimerCommit = () => {
            ripples.show(e, element, value);
        };
        element._ripple.showTimer = window.setTimeout(() => {
            if (element && element._ripple && element._ripple.showTimerCommit) {
                element._ripple.showTimerCommit();
                element._ripple.showTimerCommit = null;
            }
        }, DELAY_RIPPLE);
    }
    else {
        ripples.show(e, element, value);
    }
}
function rippleHide(e) {
    const element = e.currentTarget;
    if (!element || !element._ripple)
        return;
    window.clearTimeout(element._ripple.showTimer);
    // The touch interaction occurs before the show timer is triggered.
    // We still want to show ripple effect.
    if (e.type === 'touchend' && element._ripple.showTimerCommit) {
        element._ripple.showTimerCommit();
        element._ripple.showTimerCommit = null;
        // re-queue ripple hiding
        element._ripple.showTimer = setTimeout(() => {
            rippleHide(e);
        });
        return;
    }
    window.setTimeout(() => {
        if (element._ripple) {
            element._ripple.touched = false;
        }
    });
    ripples.hide(element);
}
function rippleCancelShow(e) {
    const element = e.currentTarget;
    if (!element || !element._ripple)
        return;
    if (element._ripple.showTimerCommit) {
        element._ripple.showTimerCommit = null;
    }
    window.clearTimeout(element._ripple.showTimer);
}
let keyboardRipple = false;
function keyboardRippleShow(e) {
    if (!keyboardRipple && (e.keyCode === keyCodes.enter || e.keyCode === keyCodes.space)) {
        keyboardRipple = true;
        rippleShow(e);
    }
}
function keyboardRippleHide(e) {
    keyboardRipple = false;
    rippleHide(e);
}
function updateRipple(el, binding, wasEnabled) {
    const enabled = isRippleEnabled(binding.value);
    if (!enabled) {
        ripples.hide(el);
    }
    el._ripple = el._ripple || {};
    el._ripple.enabled = enabled;
    const value = binding.value || {};
    if (value.center) {
        el._ripple.centered = true;
    }
    if (value.class) {
        el._ripple.class = binding.value.class;
    }
    if (value.circle) {
        el._ripple.circle = value.circle;
    }
    if (enabled && !wasEnabled) {
        el.addEventListener('touchstart', rippleShow, { passive: true });
        el.addEventListener('touchend', rippleHide, { passive: true });
        el.addEventListener('touchmove', rippleCancelShow, { passive: true });
        el.addEventListener('touchcancel', rippleHide);
        el.addEventListener('mousedown', rippleShow);
        el.addEventListener('mouseup', rippleHide);
        el.addEventListener('mouseleave', rippleHide);
        el.addEventListener('keydown', keyboardRippleShow);
        el.addEventListener('keyup', keyboardRippleHide);
        // Anchor tags can be dragged, causes other hides to fail - #1537
        el.addEventListener('dragstart', rippleHide, { passive: true });
    }
    else if (!enabled && wasEnabled) {
        removeListeners(el);
    }
}
function removeListeners(el) {
    el.removeEventListener('mousedown', rippleShow);
    el.removeEventListener('touchstart', rippleShow);
    el.removeEventListener('touchend', rippleHide);
    el.removeEventListener('touchmove', rippleCancelShow);
    el.removeEventListener('touchcancel', rippleHide);
    el.removeEventListener('mouseup', rippleHide);
    el.removeEventListener('mouseleave', rippleHide);
    el.removeEventListener('keydown', keyboardRippleShow);
    el.removeEventListener('keyup', keyboardRippleHide);
    el.removeEventListener('dragstart', rippleHide);
}
function directive(el, binding, node) {
    updateRipple(el, binding, false);
    if (process.env.NODE_ENV === 'development') {
        // warn if an inline element is used, waiting for el to be in the DOM first
        node.context && node.context.$nextTick(() => {
            const computed = window.getComputedStyle(el);
            if (computed && computed.display === 'inline') {
                const context = node.fnOptions ? [node.fnOptions, node.context] : [node.componentInstance];
                consoleWarn('v-ripple can only be used on block-level elements', ...context);
            }
        });
    }
}
function unbind(el) {
    delete el._ripple;
    removeListeners(el);
}
function update(el, binding) {
    if (binding.value === binding.oldValue) {
        return;
    }
    const wasEnabled = isRippleEnabled(binding.oldValue);
    updateRipple(el, binding, wasEnabled);
}
export const Ripple = {
    bind: directive,
    unbind,
    update,
};
export default Ripple;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZGlyZWN0aXZlcy9yaXBwbGUvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUztBQUNULE9BQU8sZ0JBQWdCLENBQUE7QUFFdkIsWUFBWTtBQUNaLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUNoRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFPN0MsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFBO0FBRXZCLFNBQVMsU0FBUyxDQUFFLEVBQWUsRUFBRSxLQUFhO0lBQ2hELEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsS0FBSyxDQUFBO0lBQzdCLEVBQUUsQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsR0FBRyxLQUFLLENBQUE7QUFDckMsQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFFLEVBQWUsRUFBRSxLQUFhO0lBQzlDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFBO0FBQ3hDLENBQUM7QUFRRCxTQUFTLFlBQVksQ0FBRSxDQUFxQjtJQUMxQyxPQUFPLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLFlBQVksQ0FBQTtBQUM1QyxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUUsQ0FBcUI7SUFDN0MsT0FBTyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxlQUFlLENBQUE7QUFDL0MsQ0FBQztBQUVELE1BQU0sU0FBUyxHQUFHLENBQ2hCLENBQXFCLEVBQ3JCLEVBQWUsRUFDZixRQUF1QixFQUFFLEVBQ3pCLEVBQUU7SUFDRixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUE7SUFDZCxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUE7SUFFZCxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ3ZCLE1B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QUUsSUFBWSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUE7Z0JBQzVHLFdBQVcsQ0FBQyxtREFBbUQsRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFBO2FBQzdFO1FBQ0gsQ0FBQyxDQUFDLENBQUE7S0FDSDtBQUNILENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBRSxFQUFlO0lBQzlCLE9BQU8sRUFBRSxDQUFDLE9BQU8sQ0FBQTtJQUNqQixlQUFlLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDckIsQ0FBQztBQUVELFNBQVMsTUFBTSxDQUFFLEVBQWUsRUFBRSxPQUF1QjtJQUN2RCxJQUFJLE9BQU8sQ0FBQyxLQUFLLEtBQUssT0FBTyxDQUFDLFFBQVEsRUFBRTtRQUN0QyxPQUFNO0tBQ1A7SUFFRCxNQUFNLFVBQVUsR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQ3BELFlBQVksQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQ3ZDLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUc7SUFDcEIsSUFBSSxFQUFFLFNBQVM7SUFDZixNQUFNO0lBQ04sTUFBTTtDQUNQLENBQUE7QUFFRCxlQUFlLE1BQU0sQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFN0eWxlc1xuaW1wb3J0ICcuL1ZSaXBwbGUuc2FzcydcblxuLy8gVXRpbGl0aWVzXG5pbXBvcnQgeyBjb25zb2xlV2FybiB9IGZyb20gJy4uLy4uL3V0aWwvY29uc29sZSdcbmltcG9ydCB7IGtleUNvZGVzIH0gZnJvbSAnLi4vLi4vdXRpbC9oZWxwZXJzJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUsIFZOb2RlRGlyZWN0aXZlIH0gZnJvbSAndnVlJ1xuXG50eXBlIFZ1ZXRpZnlSaXBwbGVFdmVudCA9IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50IHwgS2V5Ym9hcmRFdmVudFxuXG5jb25zdCBERUxBWV9SSVBQTEUgPSA4MFxuXG5mdW5jdGlvbiB0cmFuc2Zvcm0gKGVsOiBIVE1MRWxlbWVudCwgdmFsdWU6IHN0cmluZykge1xuICBlbC5zdHlsZVsndHJhbnNmb3JtJ10gPSB2YWx1ZVxuICBlbC5zdHlsZVsnd2Via2l0VHJhbnNmb3JtJ10gPSB2YWx1ZVxufVxuXG5mdW5jdGlvbiBvcGFjaXR5IChlbDogSFRNTEVsZW1lbnQsIHZhbHVlOiBudW1iZXIpIHtcbiAgZWwuc3R5bGVbJ29wYWNpdHknXSA9IHZhbHVlLnRvU3RyaW5nKClcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSaXBwbGVPcHRpb25zIHtcbiAgY2xhc3M/OiBzdHJpbmdcbiAgY2VudGVyPzogYm9vbGVhblxuICBjaXJjbGU/OiBib29sZWFuXG59XG5cbmZ1bmN0aW9uIGlzVG91Y2hFdmVudCAoZTogVnVldGlmeVJpcHBsZUV2ZW50KTogZSBpcyBUb3VjaEV2ZW50IHtcbiAgcmV0dXJuIGUuY29uc3RydWN0b3IubmFtZSA9PT0gJ1RvdWNoRXZlbnQnXG59XG5cbmZ1bmN0aW9uIGlzS2V5Ym9hcmRFdmVudCAoZTogVnVldGlmeVJpcHBsZUV2ZW50KTogZSBpcyBLZXlib2FyZEV2ZW50IHtcbiAgcmV0dXJuIGUuY29uc3RydWN0b3IubmFtZSA9PT0gJ0tleWJvYXJkRXZlbnQnXG59XG5cbmNvbnN0IGNhbGN1bGF0ZSA9IChcbiAgZTogVnVldGlmeVJpcHBsZUV2ZW50LFxuICBlbDogSFRNTEVsZW1lbnQsXG4gIHZhbHVlOiBSaXBwbGVPcHRpb25zID0ge31cbikgPT4ge1xuICBsZXQgbG9jYWxYID0gMFxuICBsZXQgbG9jYWxZID0gMFxuXG4gIGlmICghaXNLZXlib2FyZEV2ZW50KGUpKSB7XG4gICAgY29uc3Qgb2Zmc2V0ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICBjb25zdCB0YXJnZXQgPSBpc1RvdWNoRXZlbnQoZSkgPyBlLnRvdWNoZXNbZS50b3VjaGVzLmxlbmd0aCAtIDFdIDogZVxuXG4gICAgbG9jYWxYID0gdGFyZ2V0LmNsaWVudFggLSBvZmZzZXQubGVmdFxuICAgIGxvY2FsWSA9IHRhcmdldC5jbGllbnRZIC0gb2Zmc2V0LnRvcFxuICB9XG5cbiAgbGV0IHJhZGl1cyA9IDBcbiAgbGV0IHNjYWxlID0gMC4zXG4gIGlmIChlbC5fcmlwcGxlICYmIGVsLl9yaXBwbGUuY2lyY2xlKSB7XG4gICAgc2NhbGUgPSAwLjE1XG4gICAgcmFkaXVzID0gZWwuY2xpZW50V2lkdGggLyAyXG4gICAgcmFkaXVzID0gdmFsdWUuY2VudGVyID8gcmFkaXVzIDogcmFkaXVzICsgTWF0aC5zcXJ0KChsb2NhbFggLSByYWRpdXMpICoqIDIgKyAobG9jYWxZIC0gcmFkaXVzKSAqKiAyKSAvIDRcbiAgfSBlbHNlIHtcbiAgICByYWRpdXMgPSBNYXRoLnNxcnQoZWwuY2xpZW50V2lkdGggKiogMiArIGVsLmNsaWVudEhlaWdodCAqKiAyKSAvIDJcbiAgfVxuXG4gIGNvbnN0IGNlbnRlclggPSBgJHsoZWwuY2xpZW50V2lkdGggLSAocmFkaXVzICogMikpIC8gMn1weGBcbiAgY29uc3QgY2VudGVyWSA9IGAkeyhlbC5jbGllbnRIZWlnaHQgLSAocmFkaXVzICogMikpIC8gMn1weGBcblxuICBjb25zdCB4ID0gdmFsdWUuY2VudGVyID8gY2VudGVyWCA6IGAke2xvY2FsWCAtIHJhZGl1c31weGBcbiAgY29uc3QgeSA9IHZhbHVlLmNlbnRlciA/IGNlbnRlclkgOiBgJHtsb2NhbFkgLSByYWRpdXN9cHhgXG5cbiAgcmV0dXJuIHsgcmFkaXVzLCBzY2FsZSwgeCwgeSwgY2VudGVyWCwgY2VudGVyWSB9XG59XG5cbmNvbnN0IHJpcHBsZXMgPSB7XG4gIC8qIGVzbGludC1kaXNhYmxlIG1heC1zdGF0ZW1lbnRzICovXG4gIHNob3cgKFxuICAgIGU6IFZ1ZXRpZnlSaXBwbGVFdmVudCxcbiAgICBlbDogSFRNTEVsZW1lbnQsXG4gICAgdmFsdWU6IFJpcHBsZU9wdGlvbnMgPSB7fVxuICApIHtcbiAgICBpZiAoIWVsLl9yaXBwbGUgfHwgIWVsLl9yaXBwbGUuZW5hYmxlZCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpXG4gICAgY29uc3QgYW5pbWF0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpXG5cbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoYW5pbWF0aW9uKVxuICAgIGNvbnRhaW5lci5jbGFzc05hbWUgPSAndi1yaXBwbGVfX2NvbnRhaW5lcidcblxuICAgIGlmICh2YWx1ZS5jbGFzcykge1xuICAgICAgY29udGFpbmVyLmNsYXNzTmFtZSArPSBgICR7dmFsdWUuY2xhc3N9YFxuICAgIH1cblxuICAgIGNvbnN0IHsgcmFkaXVzLCBzY2FsZSwgeCwgeSwgY2VudGVyWCwgY2VudGVyWSB9ID0gY2FsY3VsYXRlKGUsIGVsLCB2YWx1ZSlcblxuICAgIGNvbnN0IHNpemUgPSBgJHtyYWRpdXMgKiAyfXB4YFxuICAgIGFuaW1hdGlvbi5jbGFzc05hbWUgPSAndi1yaXBwbGVfX2FuaW1hdGlvbidcbiAgICBhbmltYXRpb24uc3R5bGUud2lkdGggPSBzaXplXG4gICAgYW5pbWF0aW9uLnN0eWxlLmhlaWdodCA9IHNpemVcblxuICAgIGVsLmFwcGVuZENoaWxkKGNvbnRhaW5lcilcblxuICAgIGNvbnN0IGNvbXB1dGVkID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpXG4gICAgaWYgKGNvbXB1dGVkICYmIGNvbXB1dGVkLnBvc2l0aW9uID09PSAnc3RhdGljJykge1xuICAgICAgZWwuc3R5bGUucG9zaXRpb24gPSAncmVsYXRpdmUnXG4gICAgICBlbC5kYXRhc2V0LnByZXZpb3VzUG9zaXRpb24gPSAnc3RhdGljJ1xuICAgIH1cblxuICAgIGFuaW1hdGlvbi5jbGFzc0xpc3QuYWRkKCd2LXJpcHBsZV9fYW5pbWF0aW9uLS1lbnRlcicpXG4gICAgYW5pbWF0aW9uLmNsYXNzTGlzdC5hZGQoJ3YtcmlwcGxlX19hbmltYXRpb24tLXZpc2libGUnKVxuICAgIHRyYW5zZm9ybShhbmltYXRpb24sIGB0cmFuc2xhdGUoJHt4fSwgJHt5fSkgc2NhbGUzZCgke3NjYWxlfSwke3NjYWxlfSwke3NjYWxlfSlgKVxuICAgIG9wYWNpdHkoYW5pbWF0aW9uLCAwKVxuICAgIGFuaW1hdGlvbi5kYXRhc2V0LmFjdGl2YXRlZCA9IFN0cmluZyhwZXJmb3JtYW5jZS5ub3coKSlcblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgYW5pbWF0aW9uLmNsYXNzTGlzdC5yZW1vdmUoJ3YtcmlwcGxlX19hbmltYXRpb24tLWVudGVyJylcbiAgICAgIGFuaW1hdGlvbi5jbGFzc0xpc3QuYWRkKCd2LXJpcHBsZV9fYW5pbWF0aW9uLS1pbicpXG4gICAgICB0cmFuc2Zvcm0oYW5pbWF0aW9uLCBgdHJhbnNsYXRlKCR7Y2VudGVyWH0sICR7Y2VudGVyWX0pIHNjYWxlM2QoMSwxLDEpYClcbiAgICAgIG9wYWNpdHkoYW5pbWF0aW9uLCAwLjI1KVxuICAgIH0sIDApXG4gIH0sXG5cbiAgaGlkZSAoZWw6IEhUTUxFbGVtZW50IHwgbnVsbCkge1xuICAgIGlmICghZWwgfHwgIWVsLl9yaXBwbGUgfHwgIWVsLl9yaXBwbGUuZW5hYmxlZCkgcmV0dXJuXG5cbiAgICBjb25zdCByaXBwbGVzID0gZWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgndi1yaXBwbGVfX2FuaW1hdGlvbicpXG5cbiAgICBpZiAocmlwcGxlcy5sZW5ndGggPT09IDApIHJldHVyblxuICAgIGNvbnN0IGFuaW1hdGlvbiA9IHJpcHBsZXNbcmlwcGxlcy5sZW5ndGggLSAxXVxuXG4gICAgaWYgKGFuaW1hdGlvbi5kYXRhc2V0LmlzSGlkaW5nKSByZXR1cm5cbiAgICBlbHNlIGFuaW1hdGlvbi5kYXRhc2V0LmlzSGlkaW5nID0gJ3RydWUnXG5cbiAgICBjb25zdCBkaWZmID0gcGVyZm9ybWFuY2Uubm93KCkgLSBOdW1iZXIoYW5pbWF0aW9uLmRhdGFzZXQuYWN0aXZhdGVkKVxuICAgIGNvbnN0IGRlbGF5ID0gTWF0aC5tYXgoMjUwIC0gZGlmZiwgMClcblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgYW5pbWF0aW9uLmNsYXNzTGlzdC5yZW1vdmUoJ3YtcmlwcGxlX19hbmltYXRpb24tLWluJylcbiAgICAgIGFuaW1hdGlvbi5jbGFzc0xpc3QuYWRkKCd2LXJpcHBsZV9fYW5pbWF0aW9uLS1vdXQnKVxuICAgICAgb3BhY2l0eShhbmltYXRpb24sIDApXG5cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25zdCByaXBwbGVzID0gZWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgndi1yaXBwbGVfX2FuaW1hdGlvbicpXG4gICAgICAgIGlmIChyaXBwbGVzLmxlbmd0aCA9PT0gMSAmJiBlbC5kYXRhc2V0LnByZXZpb3VzUG9zaXRpb24pIHtcbiAgICAgICAgICBlbC5zdHlsZS5wb3NpdGlvbiA9IGVsLmRhdGFzZXQucHJldmlvdXNQb3NpdGlvblxuICAgICAgICAgIGRlbGV0ZSBlbC5kYXRhc2V0LnByZXZpb3VzUG9zaXRpb25cbiAgICAgICAgfVxuXG4gICAgICAgIGFuaW1hdGlvbi5wYXJlbnROb2RlICYmIGVsLnJlbW92ZUNoaWxkKGFuaW1hdGlvbi5wYXJlbnROb2RlKVxuICAgICAgfSwgMzAwKVxuICAgIH0sIGRlbGF5KVxuICB9LFxufVxuXG5mdW5jdGlvbiBpc1JpcHBsZUVuYWJsZWQgKHZhbHVlOiBhbnkpOiB2YWx1ZSBpcyB0cnVlIHtcbiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgISF2YWx1ZVxufVxuXG5mdW5jdGlvbiByaXBwbGVTaG93IChlOiBWdWV0aWZ5UmlwcGxlRXZlbnQpIHtcbiAgY29uc3QgdmFsdWU6IFJpcHBsZU9wdGlvbnMgPSB7fVxuICBjb25zdCBlbGVtZW50ID0gZS5jdXJyZW50VGFyZ2V0IGFzIEhUTUxFbGVtZW50XG4gIGlmICghZWxlbWVudCB8fCAhZWxlbWVudC5fcmlwcGxlIHx8IGVsZW1lbnQuX3JpcHBsZS50b3VjaGVkKSByZXR1cm5cbiAgaWYgKGlzVG91Y2hFdmVudChlKSkge1xuICAgIGVsZW1lbnQuX3JpcHBsZS50b3VjaGVkID0gdHJ1ZVxuICAgIGVsZW1lbnQuX3JpcHBsZS5pc1RvdWNoID0gdHJ1ZVxuICB9IGVsc2Uge1xuICAgIC8vIEl0J3MgcG9zc2libGUgZm9yIHRvdWNoIGV2ZW50cyB0byBmaXJlXG4gICAgLy8gYXMgbW91c2UgZXZlbnRzIG9uIEFuZHJvaWQvaU9TLCB0aGlzXG4gICAgLy8gd2lsbCBza2lwIHRoZSBldmVudCBjYWxsIGlmIGl0IGhhc1xuICAgIC8vIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIGFzIHRvdWNoXG4gICAgaWYgKGVsZW1lbnQuX3JpcHBsZS5pc1RvdWNoKSByZXR1cm5cbiAgfVxuICB2YWx1ZS5jZW50ZXIgPSBlbGVtZW50Ll9yaXBwbGUuY2VudGVyZWQgfHwgaXNLZXlib2FyZEV2ZW50KGUpXG4gIGlmIChlbGVtZW50Ll9yaXBwbGUuY2xhc3MpIHtcbiAgICB2YWx1ZS5jbGFzcyA9IGVsZW1lbnQuX3JpcHBsZS5jbGFzc1xuICB9XG5cbiAgaWYgKGlzVG91Y2hFdmVudChlKSkge1xuICAgIC8vIGFscmVhZHkgcXVldWVkIHRoYXQgc2hvd3Mgb3IgaGlkZXMgdGhlIHJpcHBsZVxuICAgIGlmIChlbGVtZW50Ll9yaXBwbGUuc2hvd1RpbWVyQ29tbWl0KSByZXR1cm5cblxuICAgIGVsZW1lbnQuX3JpcHBsZS5zaG93VGltZXJDb21taXQgPSAoKSA9PiB7XG4gICAgICByaXBwbGVzLnNob3coZSwgZWxlbWVudCwgdmFsdWUpXG4gICAgfVxuICAgIGVsZW1lbnQuX3JpcHBsZS5zaG93VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50Ll9yaXBwbGUgJiYgZWxlbWVudC5fcmlwcGxlLnNob3dUaW1lckNvbW1pdCkge1xuICAgICAgICBlbGVtZW50Ll9yaXBwbGUuc2hvd1RpbWVyQ29tbWl0KClcbiAgICAgICAgZWxlbWVudC5fcmlwcGxlLnNob3dUaW1lckNvbW1pdCA9IG51bGxcbiAgICAgIH1cbiAgICB9LCBERUxBWV9SSVBQTEUpXG4gIH0gZWxzZSB7XG4gICAgcmlwcGxlcy5zaG93KGUsIGVsZW1lbnQsIHZhbHVlKVxuICB9XG59XG5cbmZ1bmN0aW9uIHJpcHBsZUhpZGUgKGU6IEV2ZW50KSB7XG4gIGNvbnN0IGVsZW1lbnQgPSBlLmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQgfCBudWxsXG4gIGlmICghZWxlbWVudCB8fCAhZWxlbWVudC5fcmlwcGxlKSByZXR1cm5cblxuICB3aW5kb3cuY2xlYXJUaW1lb3V0KGVsZW1lbnQuX3JpcHBsZS5zaG93VGltZXIpXG5cbiAgLy8gVGhlIHRvdWNoIGludGVyYWN0aW9uIG9jY3VycyBiZWZvcmUgdGhlIHNob3cgdGltZXIgaXMgdHJpZ2dlcmVkLlxuICAvLyBXZSBzdGlsbCB3YW50IHRvIHNob3cgcmlwcGxlIGVmZmVjdC5cbiAgaWYgKGUudHlwZSA9PT0gJ3RvdWNoZW5kJyAmJiBlbGVtZW50Ll9yaXBwbGUuc2hvd1RpbWVyQ29tbWl0KSB7XG4gICAgZWxlbWVudC5fcmlwcGxlLnNob3dUaW1lckNvbW1pdCgpXG4gICAgZWxlbWVudC5fcmlwcGxlLnNob3dUaW1lckNvbW1pdCA9IG51bGxcblxuICAgIC8vIHJlLXF1ZXVlIHJpcHBsZSBoaWRpbmdcbiAgICBlbGVtZW50Ll9yaXBwbGUuc2hvd1RpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICByaXBwbGVIaWRlKGUpXG4gICAgfSlcbiAgICByZXR1cm5cbiAgfVxuXG4gIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICBpZiAoZWxlbWVudC5fcmlwcGxlKSB7XG4gICAgICBlbGVtZW50Ll9yaXBwbGUudG91Y2hlZCA9IGZhbHNlXG4gICAgfVxuICB9KVxuICByaXBwbGVzLmhpZGUoZWxlbWVudClcbn1cblxuZnVuY3Rpb24gcmlwcGxlQ2FuY2VsU2hvdyAoZTogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpIHtcbiAgY29uc3QgZWxlbWVudCA9IGUuY3VycmVudFRhcmdldCBhcyBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZFxuXG4gIGlmICghZWxlbWVudCB8fCAhZWxlbWVudC5fcmlwcGxlKSByZXR1cm5cblxuICBpZiAoZWxlbWVudC5fcmlwcGxlLnNob3dUaW1lckNvbW1pdCkge1xuICAgIGVsZW1lbnQuX3JpcHBsZS5zaG93VGltZXJDb21taXQgPSBudWxsXG4gIH1cblxuICB3aW5kb3cuY2xlYXJUaW1lb3V0KGVsZW1lbnQuX3JpcHBsZS5zaG93VGltZXIpXG59XG5cbmxldCBrZXlib2FyZFJpcHBsZSA9IGZhbHNlXG5cbmZ1bmN0aW9uIGtleWJvYXJkUmlwcGxlU2hvdyAoZTogS2V5Ym9hcmRFdmVudCkge1xuICBpZiAoIWtleWJvYXJkUmlwcGxlICYmIChlLmtleUNvZGUgPT09IGtleUNvZGVzLmVudGVyIHx8IGUua2V5Q29kZSA9PT0ga2V5Q29kZXMuc3BhY2UpKSB7XG4gICAga2V5Ym9hcmRSaXBwbGUgPSB0cnVlXG4gICAgcmlwcGxlU2hvdyhlKVxuICB9XG59XG5cbmZ1bmN0aW9uIGtleWJvYXJkUmlwcGxlSGlkZSAoZTogS2V5Ym9hcmRFdmVudCkge1xuICBrZXlib2FyZFJpcHBsZSA9IGZhbHNlXG4gIHJpcHBsZUhpZGUoZSlcbn1cblxuZnVuY3Rpb24gdXBkYXRlUmlwcGxlIChlbDogSFRNTEVsZW1lbnQsIGJpbmRpbmc6IFZOb2RlRGlyZWN0aXZlLCB3YXNFbmFibGVkOiBib29sZWFuKSB7XG4gIGNvbnN0IGVuYWJsZWQgPSBpc1JpcHBsZUVuYWJsZWQoYmluZGluZy52YWx1ZSlcbiAgaWYgKCFlbmFibGVkKSB7XG4gICAgcmlwcGxlcy5oaWRlKGVsKVxuICB9XG4gIGVsLl9yaXBwbGUgPSBlbC5fcmlwcGxlIHx8IHt9XG4gIGVsLl9yaXBwbGUuZW5hYmxlZCA9IGVuYWJsZWRcbiAgY29uc3QgdmFsdWUgPSBiaW5kaW5nLnZhbHVlIHx8IHt9XG4gIGlmICh2YWx1ZS5jZW50ZXIpIHtcbiAgICBlbC5fcmlwcGxlLmNlbnRlcmVkID0gdHJ1ZVxuICB9XG4gIGlmICh2YWx1ZS5jbGFzcykge1xuICAgIGVsLl9yaXBwbGUuY2xhc3MgPSBiaW5kaW5nLnZhbHVlLmNsYXNzXG4gIH1cbiAgaWYgKHZhbHVlLmNpcmNsZSkge1xuICAgIGVsLl9yaXBwbGUuY2lyY2xlID0gdmFsdWUuY2lyY2xlXG4gIH1cbiAgaWYgKGVuYWJsZWQgJiYgIXdhc0VuYWJsZWQpIHtcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgcmlwcGxlU2hvdywgeyBwYXNzaXZlOiB0cnVlIH0pXG4gICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCByaXBwbGVIaWRlLCB7IHBhc3NpdmU6IHRydWUgfSlcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCByaXBwbGVDYW5jZWxTaG93LCB7IHBhc3NpdmU6IHRydWUgfSlcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHJpcHBsZUhpZGUpXG5cbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCByaXBwbGVTaG93KVxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCByaXBwbGVIaWRlKVxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCByaXBwbGVIaWRlKVxuXG4gICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGtleWJvYXJkUmlwcGxlU2hvdylcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIGtleWJvYXJkUmlwcGxlSGlkZSlcblxuICAgIC8vIEFuY2hvciB0YWdzIGNhbiBiZSBkcmFnZ2VkLCBjYXVzZXMgb3RoZXIgaGlkZXMgdG8gZmFpbCAtICMxNTM3XG4gICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ3N0YXJ0JywgcmlwcGxlSGlkZSwgeyBwYXNzaXZlOiB0cnVlIH0pXG4gIH0gZWxzZSBpZiAoIWVuYWJsZWQgJiYgd2FzRW5hYmxlZCkge1xuICAgIHJlbW92ZUxpc3RlbmVycyhlbClcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVMaXN0ZW5lcnMgKGVsOiBIVE1MRWxlbWVudCkge1xuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCByaXBwbGVTaG93KVxuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgcmlwcGxlU2hvdylcbiAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCByaXBwbGVIaWRlKVxuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCByaXBwbGVDYW5jZWxTaG93KVxuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHJpcHBsZUhpZGUpXG4gIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCByaXBwbGVIaWRlKVxuICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgcmlwcGxlSGlkZSlcbiAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGtleWJvYXJkUmlwcGxlU2hvdylcbiAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBrZXlib2FyZFJpcHBsZUhpZGUpXG4gIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2RyYWdzdGFydCcsIHJpcHBsZUhpZGUpXG59XG5cbmZ1bmN0aW9uIGRpcmVjdGl2ZSAoZWw6IEhUTUxFbGVtZW50LCBiaW5kaW5nOiBWTm9kZURpcmVjdGl2ZSwgbm9kZTogVk5vZGUpIHtcbiAgdXBkYXRlUmlwcGxlKGVsLCBiaW5kaW5nLCBmYWxzZSlcblxuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAvLyB3YXJuIGlmIGFuIGlubGluZSBlbGVtZW50IGlzIHVzZWQsIHdhaXRpbmcgZm9yIGVsIHRvIGJlIGluIHRoZSBET00gZmlyc3RcbiAgICBub2RlLmNvbnRleHQgJiYgbm9kZS5jb250ZXh0LiRuZXh0VGljaygoKSA9PiB7XG4gICAgICBjb25zdCBjb21wdXRlZCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKVxuICAgICAgaWYgKGNvbXB1dGVkICYmIGNvbXB1dGVkLmRpc3BsYXkgPT09ICdpbmxpbmUnKSB7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSAobm9kZSBhcyBhbnkpLmZuT3B0aW9ucyA/IFsobm9kZSBhcyBhbnkpLmZuT3B0aW9ucywgbm9kZS5jb250ZXh0XSA6IFtub2RlLmNvbXBvbmVudEluc3RhbmNlXVxuICAgICAgICBjb25zb2xlV2Fybigndi1yaXBwbGUgY2FuIG9ubHkgYmUgdXNlZCBvbiBibG9jay1sZXZlbCBlbGVtZW50cycsIC4uLmNvbnRleHQpXG4gICAgICB9XG4gICAgfSlcbiAgfVxufVxuXG5mdW5jdGlvbiB1bmJpbmQgKGVsOiBIVE1MRWxlbWVudCkge1xuICBkZWxldGUgZWwuX3JpcHBsZVxuICByZW1vdmVMaXN0ZW5lcnMoZWwpXG59XG5cbmZ1bmN0aW9uIHVwZGF0ZSAoZWw6IEhUTUxFbGVtZW50LCBiaW5kaW5nOiBWTm9kZURpcmVjdGl2ZSkge1xuICBpZiAoYmluZGluZy52YWx1ZSA9PT0gYmluZGluZy5vbGRWYWx1ZSkge1xuICAgIHJldHVyblxuICB9XG5cbiAgY29uc3Qgd2FzRW5hYmxlZCA9IGlzUmlwcGxlRW5hYmxlZChiaW5kaW5nLm9sZFZhbHVlKVxuICB1cGRhdGVSaXBwbGUoZWwsIGJpbmRpbmcsIHdhc0VuYWJsZWQpXG59XG5cbmV4cG9ydCBjb25zdCBSaXBwbGUgPSB7XG4gIGJpbmQ6IGRpcmVjdGl2ZSxcbiAgdW5iaW5kLFxuICB1cGRhdGUsXG59XG5cbmV4cG9ydCBkZWZhdWx0IFJpcHBsZVxuIl19